<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Sakina Space</title>
<meta name="theme-color" content="#07090f">
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --night:#07090f;--deep:#0d1220;--card:#111827;--card2:#1a2540;
  --border:rgba(255,255,255,.07);--border2:rgba(255,255,255,.13);
  --gold:#d4a843;--gold2:#f0cc6e;--gold3:rgba(212,168,67,.12);
  --teal:#0f8c7e;--teal2:#13b5a4;--teal3:rgba(19,181,164,.12);
  --rose:#c45a7a;--rose2:#e87a9c;
  --purple:#7c3aed;--purple2:#a78bfa;
  --text:#e8e0d0;--muted:#5a6580;--muted2:#8a96b0;--green:#3fb950;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{height:100%;height:-webkit-fill-available}
body{
  height:100%;height:100dvh;
  overflow:hidden;font-family:'Tajawal',sans-serif;
  background:var(--night);color:var(--text);font-size:15px;
  touch-action:manipulation;
}
button{font-family:'Tajawal',sans-serif;cursor:pointer}
input{font-family:'Tajawal',sans-serif}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:var(--card2);border-radius:4px}
svg.icon{display:inline-block;vertical-align:middle;flex-shrink:0}

/* SKY */
#sky{position:fixed;inset:0;z-index:0;background:linear-gradient(180deg,#060810 0%,#0b1220 50%,#0f1a2e 100%);overflow:hidden;pointer-events:none}
.star{position:absolute;border-radius:50%;background:#fff;animation:twinkle var(–d,3s) infinite ease-in-out var(–dl,0s)}
@keyframes twinkle{0%,100%{opacity:var(–op,.5)}50%{opacity:.05}}
.moon{position:absolute;top:16px;right:50px;width:52px;height:52px;background:radial-gradient(circle at 35% 35%,#f5d97a,#c9910a);border-radius:50%;box-shadow:0 0 30px rgba(212,168,67,.5),0 0 60px rgba(212,168,67,.2)}
.moon::after{content:’’;position:absolute;top:6px;left:12px;width:42px;height:42px;border-radius:50%;background:#0a0e1a;opacity:.82}
.particle{position:fixed;border-radius:50%;pointer-events:none;z-index:999;animation:floatUp var(–dur,1s) ease-out forwards}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-80px) scale(.3)}}

/* APP */
#app{position:relative;z-index:1;height:100dvh;display:flex;flex-direction:column}

/* LOGIN */
#login-screen{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;padding:20px;background:rgba(7,9,15,.95);overflow-y:auto}
.lcard{background:rgba(13,18,32,.98);border:1px solid rgba(212,168,67,.2);border-radius:24px;padding:32px 28px;width:100%;max-width:380px;box-shadow:0 40px 100px rgba(0,0,0,.7);margin:auto}
.lcard-top{text-align:center;margin-bottom:24px}
.lcard-top .la{font-family:‘Amiri’,serif;font-size:2rem;color:var(–gold);opacity:.85}
.lcard-top h1{font-family:‘Amiri’,serif;font-size:2.2rem;color:var(–gold2)}
.lcard-top .ls{font-size:.7rem;letter-spacing:2px;text-transform:uppercase;color:var(–muted2);margin-top:2px}
label.lbl{display:block;font-size:.63rem;letter-spacing:2px;text-transform:uppercase;color:var(–muted);margin-bottom:5px}
input.li{width:100%;background:rgba(255,255,255,.04);border:1px solid var(–border2);border-radius:10px;padding:12px 14px;color:var(–text);font-size:.92rem;outline:none;transition:border-color .2s;margin-bottom:12px}
input.li:focus{border-color:var(–gold)}
.hint{font-size:.68rem;color:var(–muted);margin-bottom:14px;line-height:1.5;padding:8px 10px;background:rgba(255,255,255,.03);border-radius:8px;border:1px solid var(–border)}
.hint strong{color:var(–gold)}
.btn-gold{background:linear-gradient(135deg,var(–gold),var(–gold2));border:none;border-radius:10px;padding:13px;color:var(–night);font-weight:700;font-size:.8rem;letter-spacing:1.5px;text-transform:uppercase;transition:opacity .2s;width:100%;margin-top:4px;display:block}
.btn-gold:hover{opacity:.88}
.btn-teal{background:linear-gradient(135deg,var(–teal),var(–teal2));border:none;border-radius:10px;padding:13px;color:#fff;font-weight:700;font-size:.8rem;letter-spacing:1.5px;text-transform:uppercase;transition:opacity .2s;width:100%;display:block}
.btn-ghost{background:none;border:1px solid var(–border2);border-radius:10px;padding:11px;color:var(–muted2);font-size:.76rem;transition:all .2s;width:100%;display:block}
.btn-ghost:hover{border-color:var(–gold);color:var(–gold)}
.btn-sm{background:var(–card2);border:1px solid var(–border);border-radius:999px;padding:6px 14px;font-size:.72rem;color:var(–muted2);cursor:pointer;transition:all .2s}
.btn-sm:hover{border-color:var(–gold);color:var(–gold)}

/* TOPBAR */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:rgba(7,9,15,.9);border-bottom:1px solid var(–border);backdrop-filter:blur(12px);flex-shrink:0;gap:8px}
.tb-logo{font-family:‘Amiri’,serif;font-size:1.1rem;color:var(–gold2)}
.tb-level{background:var(–gold3);border:1px solid rgba(212,168,67,.2);border-radius:999px;padding:2px 10px;font-size:.58rem;letter-spacing:1.5px;text-transform:uppercase;color:var(–gold)}
.tb-nour{display:flex;align-items:center;gap:5px;background:rgba(212,168,67,.08);border:1px solid rgba(212,168,67,.15);border-radius:999px;padding:4px 12px;font-size:.72rem;color:var(–gold2)}
.tb-nour-val{font-family:‘Amiri’,serif;font-size:.95rem}
.av{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.68rem;font-weight:700;border:2px solid;flex-shrink:0}
.av.me{background:rgba(212,168,67,.15);border-color:var(–gold);color:var(–gold)}
.av.other{background:rgba(19,181,164,.15);border-color:var(–teal2);color:var(–teal2);margin-left:-6px}
.online-badge{display:flex;align-items:center;gap:5px;background:rgba(19,181,164,.1);border:1px solid rgba(19,181,164,.2);border-radius:999px;padding:3px 9px;font-size:.6rem;color:var(–teal2)}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(–teal2);animation:blink 1.5s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.15}}

/* LAYOUT */
.main{flex:1;display:flex;overflow:hidden;min-height:0}
.sidebar{width:200px;flex-shrink:0;background:rgba(11,16,28,.8);border-right:1px solid var(–border);display:flex;flex-direction:column;overflow-y:auto;padding:8px 6px}
@media(max-width:640px){.sidebar{width:52px}.nlabel,.stitle{display:none}}
.stitle{font-size:.56rem;letter-spacing:2px;text-transform:uppercase;color:var(–muted);padding:8px 8px 4px}
.ni{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;cursor:pointer;transition:all .18s;color:var(–muted2);font-size:.81rem;margin-bottom:1px;border:1px solid transparent}
.ni:hover{background:rgba(255,255,255,.04);color:var(–text)}
.ni.active{background:var(–gold3);border-color:rgba(212,168,67,.2);color:var(–gold2)}
.ni-icon{width:20px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.nlabel{font-weight:500}
.nbadge{margin-left:auto;background:var(–rose);border-radius:999px;font-size:.54rem;min-width:16px;height:16px;display:flex;align-items:center;justify-content:center;padding:0 3px;color:#fff}
.content{flex:1;overflow:hidden;display:flex;flex-direction:column;min-height:0}
.panel{display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0}
.panel.active{display:flex}
.scroll-area{flex:1;overflow-y:auto;padding:14px;-webkit-overflow-scrolling:touch}

/* SHARED */
.card{background:var(–card);border:1px solid var(–border);border-radius:14px;padding:16px}
.tag{display:inline-block;border-radius:999px;padding:2px 10px;font-size:.6rem;letter-spacing:1.5px;text-transform:uppercase}
.tag.gold{background:var(–gold3);border:1px solid rgba(212,168,67,.25);color:var(–gold)}
.tag.teal{background:var(–teal3);border:1px solid rgba(19,181,164,.25);color:var(–teal2)}
.tag.rose{background:rgba(196,90,122,.1);border:1px solid rgba(196,90,122,.3);color:var(–rose2)}
.tag.purple{background:rgba(124,58,237,.1);border:1px solid rgba(167,139,250,.3);color:var(–purple2)}
.prog-bar{background:rgba(255,255,255,.05);border-radius:999px;height:5px;overflow:hidden}
.prog-fill{height:100%;border-radius:999px;transition:width .8s ease;position:relative;overflow:hidden}
.prog-fill::after{content:’’;position:absolute;top:0;left:-200%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shimmer 2s infinite}
@keyframes shimmer{to{left:200%}}
.pb-gold{background:linear-gradient(90deg,var(–gold),var(–gold2))}
.pb-teal{background:linear-gradient(90deg,var(–teal),var(–teal2))}
.pb-rose{background:linear-gradient(90deg,var(–rose),var(–rose2))}
.pb-purple{background:linear-gradient(90deg,var(–purple),var(–purple2))}
.section-title{font-size:.6rem;letter-spacing:2px;text-transform:uppercase;color:var(–muted);margin-bottom:10px}
.panel-title{font-family:‘Amiri’,serif;font-size:1.4rem;color:var(–gold2);margin-bottom:3px}
.panel-sub{font-size:.72rem;color:var(–muted2);margin-bottom:14px}
.start-screen{text-align:center;padding:28px 16px}
.start-icon{display:flex;justify-content:center;margin-bottom:12px}
.start-title{font-family:‘Amiri’,serif;font-size:1.4rem;color:var(–gold2);margin-bottom:8px}
.start-desc{font-size:.76rem;color:var(–muted2);margin-bottom:20px;line-height:1.6}

/* HOME */
.home-banner{background:linear-gradient(135deg,rgba(212,168,67,.07),rgba(19,181,164,.06));border:1px solid rgba(212,168,67,.14);border-radius:18px;padding:20px;margin-bottom:14px;text-align:center}
.hb-ar{font-family:‘Amiri’,serif;font-size:1.5rem;color:var(–gold)}
.hb-en{font-family:‘Amiri’,serif;font-size:1.7rem;color:var(–gold2);margin-top:2px}
.hb-sub{font-size:.73rem;color:var(–muted2);margin-top:4px}
.nour-wrap{background:var(–card);border:1px solid var(–border);border-radius:14px;padding:14px;margin-bottom:14px}
.nour-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.nour-label{font-size:.62rem;letter-spacing:2px;text-transform:uppercase;color:var(–gold)}
.nour-pts{font-family:‘Amiri’,serif;font-size:1.3rem;color:var(–gold2)}
.level-info{display:flex;justify-content:space-between;margin-top:4px;font-size:.62rem;color:var(–muted)}
.games-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
@media(max-width:460px){.games-grid{grid-template-columns:1fr}}
.gc{background:var(–card);border:1px solid var(–border);border-radius:14px;padding:15px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.gc:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,.3);border-color:var(–gca,var(–gold))}
.gc-glow{position:absolute;top:-20px;right:-20px;width:70px;height:70px;border-radius:50%;background:var(–gca,var(–gold));opacity:.07}
.gc:hover .gc-glow{opacity:.14}
.gc-icon{margin-bottom:5px;color:var(–gca,var(–gold))}
.gc-title{font-weight:700;font-size:.82rem;margin-bottom:2px}
.gc-sub{font-size:.68rem;color:var(–muted2)}
.gc-nour{position:absolute;bottom:9px;right:9px;font-size:.56rem;font-weight:700;padding:2px 7px;border-radius:999px;background:var(–gold3);border:1px solid rgba(212,168,67,.25);color:var(–gold)}
.ayah-box{background:var(–card);border-left:3px solid var(–gold);border-radius:12px;padding:16px;margin-bottom:14px}
.ayah-lbl{font-size:.6rem;letter-spacing:2px;text-transform:uppercase;color:var(–gold);margin-bottom:8px}
.ayah-ar{font-family:‘Amiri’,serif;font-size:1.15rem;line-height:1.7;text-align:right;direction:rtl;margin-bottom:5px}
.ayah-fr{font-size:.76rem;color:var(–muted2);font-style:italic;line-height:1.5}
.ayah-ref{font-size:.62rem;color:var(–muted);margin-top:5px}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat-item{padding:4px 0}
.stat-lbl{font-size:.6rem;color:var(–muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:3px}
.stat-val{font-family:‘Amiri’,serif;font-size:1.4rem}

/* ── CHAT ── */
.chat-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0}
.chat-msgs{flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:8px;-webkit-overflow-scrolling:touch}
.msg-sys{align-self:center;font-size:.67rem;color:var(–muted);background:rgba(255,255,255,.03);border:1px solid var(–border);border-radius:999px;padding:3px 12px}
.msg-wrap{display:flex;gap:7px;max-width:82%;animation:msgIn .25s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.msg-wrap.mine{align-self:flex-end;flex-direction:row-reverse}
.m-av{width:28px;height:28px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;margin-top:2px}
.msg-wrap:not(.mine) .m-av{background:rgba(19,181,164,.2);border:1px solid var(–teal);color:var(–teal2)}
.msg-wrap.mine .m-av{background:rgba(212,168,67,.2);border:1px solid var(–gold);color:var(–gold)}
.m-name{font-size:.6rem;color:var(–muted);margin-bottom:3px}
.msg-wrap.mine .m-name{text-align:right}
.m-bubble{padding:9px 13px;border-radius:13px;font-size:.84rem;line-height:1.5;word-break:break-word}
.msg-wrap:not(.mine) .m-bubble{background:var(–card2);border:1px solid var(–border);border-top-left-radius:4px}
.msg-wrap.mine .m-bubble{background:rgba(212,168,67,.13);border:1px solid rgba(212,168,67,.2);border-top-right-radius:4px;color:var(–gold2)}
.m-bubble.invite-bubble{background:rgba(19,181,164,.1);border:1px solid rgba(19,181,164,.3);color:var(–teal2);padding:10px 14px}
.invite-btn{background:var(–teal);border:none;border-radius:8px;padding:6px 14px;color:#fff;font-size:.72rem;font-weight:700;cursor:pointer;margin-top:7px;display:block;width:100%;transition:opacity .2s}
.invite-btn:hover{opacity:.85}
.invite-btn:disabled{opacity:.4;cursor:default}
.m-time{font-size:.58rem;color:var(–muted);margin-top:2px}
.msg-wrap.mine .m-time{text-align:right}
.chat-quickbtns{display:flex;gap:5px;padding:6px 12px;flex-wrap:wrap;border-top:1px solid var(–border)}
.qb{background:rgba(255,255,255,.04);border:1px solid var(–border);border-radius:999px;padding:4px 10px;font-size:.68rem;color:var(–muted2);cursor:pointer;transition:all .18s;display:flex;align-items:center;gap:4px;white-space:nowrap}
.qb:hover{border-color:var(–gold);color:var(–gold)}
/* KEY FIX: chat input bar stays above nav bar */
.chat-input-row{
padding:8px 12px;
padding-bottom:calc(8px + var(–safe-bottom));
border-top:1px solid var(–border);
display:flex;gap:8px;align-items:center;
background:rgba(13,18,32,.98);
flex-shrink:0;
}
.chat-input{flex:1;background:var(–card2);border:1px solid var(–border);border-radius:20px;padding:9px 14px;color:var(–text);font-size:.84rem;outline:none;transition:border-color .2s}
.chat-input:focus{border-color:rgba(212,168,67,.4)}
.send-btn{width:38px;height:38px;border-radius:50%;background:var(–gold);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(–night);transition:background .2s}
.send-btn:hover{background:var(–gold2)}

/* ── QUIZ ── */
.quiz-header{flex-shrink:0;padding:10px 14px;border-bottom:1px solid var(–border);background:rgba(7,9,15,.6)}
.quiz-scoreline{display:flex;justify-content:space-between;align-items:center;gap:6px;margin-bottom:6px}
.qsc{flex:1;text-align:center}
.qsc-name{font-size:.6rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(–muted2)}
.qsc-name.gold{color:var(–gold)}
.qsc-val{font-family:‘Amiri’,serif;font-size:1.8rem;color:#fff}
.qsc-sep{color:var(–gold);font-family:‘Amiri’,serif;padding:0 4px}
.qprogress{height:3px;background:rgba(255,255,255,.05)}
.qprogress-fill{height:100%;background:linear-gradient(90deg,var(–teal),var(–gold));transition:width .5s}
.quiz-body{flex:1;overflow-y:auto;padding:14px;-webkit-overflow-scrolling:touch}
.q-card{background:var(–card);border:1px solid rgba(212,168,67,.14);border-radius:16px;padding:16px;margin-bottom:10px}
.q-text{font-family:‘Amiri’,serif;font-size:1.1rem;line-height:1.5}
.q-answers{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
@media(max-width:440px){.q-answers{grid-template-columns:1fr}}
.q-ans{background:rgba(255,255,255,.03);border:1px solid var(–border);border-radius:10px;padding:10px 12px;cursor:pointer;font-size:.8rem;text-align:left;color:var(–text);display:flex;align-items:flex-start;gap:7px;transition:all .18s;width:100%}
.q-ans:hover:not(:disabled){border-color:var(–gold);background:rgba(212,168,67,.06)}
.q-ans.correct{background:rgba(63,185,80,.1);border-color:#4ade80;color:#bbf7d0}
.q-ans.wrong{background:rgba(248,113,113,.1);border-color:#f87171;color:#fca5a5}
.q-ans.reveal{background:rgba(63,185,80,.06);border-color:rgba(63,185,80,.3)}
.q-lbl{flex-shrink:0;width:18px;height:18px;border-radius:50%;background:rgba(212,168,67,.1);color:var(–gold);font-size:.6rem;font-weight:700;display:flex;align-items:center;justify-content:center}
.q-expl{background:var(–card2);border-left:3px solid var(–teal);border-radius:10px;padding:10px;font-size:.75rem;line-height:1.6;color:#d1fae5;display:none;margin-top:6px}
.q-expl.show{display:block;animation:msgIn .3s ease}
.q-next{display:none;width:100%;background:linear-gradient(135deg,var(–teal),var(–teal2));border:none;border-radius:10px;padding:11px;color:#fff;font-weight:700;font-size:.75rem;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;margin-top:8px}
.q-next.show{display:block;animation:msgIn .3s ease}
/* live score flash */
.score-flash{animation:scoreFlash .4s ease}
@keyframes scoreFlash{0%{transform:scale(1.4);color:var(–gold2)}100%{transform:scale(1)}}
/* waiting overlay */
.wait-overlay{position:absolute;inset:0;background:rgba(7,9,15,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;z-index:10}
.wait-spinner{width:36px;height:36px;border-radius:50%;border:3px solid var(–border2);border-top-color:var(–gold);animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── SPRINT ── */
.sprint-score-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding:8px 12px;background:var(–card);border-radius:10px;border:1px solid var(–border)}
.sprint-q{font-family:‘Amiri’,serif;font-size:1.1rem;line-height:1.5;text-align:center;margin:10px 0}
.sprint-opts{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
@media(max-width:440px){.sprint-opts{grid-template-columns:1fr}}
.sprint-opt{background:rgba(255,255,255,.04);border:1px solid var(–border);border-radius:10px;padding:10px 12px;cursor:pointer;font-size:.8rem;color:var(–text);transition:all .18s;text-align:center;width:100%}
.sprint-opt:hover:not(:disabled){border-color:var(–rose);background:rgba(196,90,122,.08)}
.sprint-opt.correct{background:rgba(63,185,80,.1);border-color:#4ade80;color:#bbf7d0;pointer-events:none}
.sprint-opt.wrong{background:rgba(248,113,113,.1);border-color:#f87171;color:#fca5a5;pointer-events:none}
.timer-ring-wrap{position:relative;width:80px;height:80px;margin:0 auto 12px}

/* ── MEMORY ── */
.mem-stats{display:flex;gap:10px;justify-content:center;margin-bottom:12px}
.mem-stat{background:var(–card);border:1px solid var(–border);border-radius:10px;padding:8px 16px;text-align:center}
.mem-stat-val{font-family:‘Amiri’,serif;font-size:1.2rem}
.mem-stat-lbl{font-size:.58rem;color:var(–muted)}
/* Simple 2-state card — no 3D transform (Android bug) */
.memory-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px}
@media(max-width:420px){.memory-grid{grid-template-columns:repeat(3,1fr);gap:6px}}
.mem-card{aspect-ratio:.85;border-radius:12px;cursor:pointer;border:1px solid var(–border);position:relative;overflow:hidden;transition:border-color .3s,box-shadow .3s;background:var(–card2)}
.mem-card.matched{border-color:var(–teal);box-shadow:0 0 14px rgba(19,181,164,.3);pointer-events:none}
.mem-face-back{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;background:var(–card2);transition:opacity .25s}
.mem-face-front{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px;text-align:center;background:var(–card);opacity:0;transition:opacity .25s;pointer-events:none}
.mem-card.flipped .mem-face-back{opacity:0;pointer-events:none}
.mem-card.flipped .mem-face-front{opacity:1}
.mem-ar{font-family:‘Amiri’,serif;font-size:1.05rem;color:var(–gold2);line-height:1.3;margin-bottom:4px}
.mem-fr{font-size:.56rem;color:var(–muted2);line-height:1.3}
.mem-type{font-size:.5rem;letter-spacing:1.5px;text-transform:uppercase;color:var(–teal2);margin-top:3px}
/* zikr colour accent */
.mem-card[data-type=“ar”] .mem-face-front{background:linear-gradient(135deg,rgba(212,168,67,.08),rgba(212,168,67,.03))}
.mem-card[data-type=“fr”] .mem-face-front{background:linear-gradient(135deg,rgba(19,181,164,.08),rgba(19,181,164,.03))}

/* ── WORD SEARCH ── */
.ws-words{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:12px}
.ws-word{background:var(–card);border:1px solid var(–border);border-radius:999px;padding:4px 12px;font-size:.7rem;letter-spacing:1px;transition:all .3s}
.ws-word.found{background:rgba(19,181,164,.1);border-color:var(–teal2);color:var(–teal2);text-decoration:line-through;opacity:.6}
.ws-grid{display:grid;grid-template-columns:repeat(10,1fr);gap:2px;margin-bottom:12px;user-select:none;-webkit-user-select:none}
.ws-cell{aspect-ratio:1;background:var(–card);border:1px solid var(–border);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;cursor:pointer;transition:all .15s;text-transform:uppercase}
.ws-cell.selected{background:rgba(212,168,67,.2);border-color:var(–gold);color:var(–gold2)}
.ws-cell.found-cell{background:rgba(19,181,164,.15);border-color:var(–teal2);color:var(–teal2)}

/* ── HADITHS ── */
.h-card{background:var(–card);border-radius:14px;padding:16px;margin-bottom:10px;border:1px solid var(–border);cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.h-card:hover{border-color:rgba(212,168,67,.25)}
.h-card::before{content:’’;position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(180deg,var(–gold),var(–teal))}
.h-num{font-size:.6rem;letter-spacing:2px;text-transform:uppercase;color:var(–muted);margin-bottom:8px}
.h-ar{font-family:‘Amiri’,serif;font-size:1.1rem;line-height:1.7;text-align:right;direction:rtl;margin-bottom:8px}
.h-fr{font-size:.79rem;color:var(–muted2);font-style:italic;line-height:1.6}
.h-src{font-size:.62rem;color:var(–gold);margin-top:6px}
.h-reveal{display:none;margin-top:10px;padding-top:10px;border-top:1px solid var(–border)}
.h-card.open .h-reveal{display:block}
.h-vertu{font-size:.76rem;color:var(–muted2);line-height:1.6}
.h-actions{display:flex;gap:6px;margin-top:10px}
.action-btn{background:none;border:1px solid var(–border);border-radius:999px;padding:5px 12px;font-size:.68rem;color:var(–muted2);cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px}
.action-btn:hover{border-color:var(–gold);color:var(–gold)}
.action-btn.liked{background:rgba(196,90,122,.1);border-color:var(–rose);color:var(–rose2)}

/* ── DUAS ── */
.dua-cats{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.dua-cat{background:rgba(255,255,255,.04);border:1px solid var(–border);border-radius:999px;padding:5px 12px;font-size:.7rem;cursor:pointer;transition:all .2s;color:var(–muted2)}
.dua-cat.active{background:var(–gold3);border-color:var(–gold);color:var(–gold)}
.dua-card{background:var(–card);border-radius:14px;padding:16px;margin-bottom:10px;border:1px solid var(–border)}
.dua-sit{font-size:.6rem;letter-spacing:2px;text-transform:uppercase;color:var(–teal2);margin-bottom:8px}
.dua-ar{font-family:‘Amiri’,serif;font-size:1.2rem;line-height:1.7;text-align:right;direction:rtl;margin-bottom:8px}
.dua-ph{font-size:.73rem;color:var(–gold);font-style:italic;margin-bottom:5px;line-height:1.5}
.dua-fr{font-size:.77rem;color:var(–muted2);line-height:1.6}
.dua-src{font-size:.62rem;color:var(–muted);margin-top:5px}

/* ── DHIKR ── */
.dhikr-select{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-bottom:14px}
.dhikr-opt{background:var(–card);border:1px solid var(–border);border-radius:10px;padding:7px 12px;font-size:.74rem;cursor:pointer;color:var(–muted2);transition:all .2s;text-align:center}
.dhikr-opt.active{background:var(–gold3);border-color:var(–gold);color:var(–gold2)}
.dhikr-opt .do-ar{font-family:‘Amiri’,serif;font-size:.92rem;display:block}
.dhikr-opt .do-fr{font-size:.58rem;margin-top:2px}
.dhikr-display{background:var(–card);border:1px solid rgba(212,168,67,.18);border-radius:20px;padding:22px;text-align:center;margin-bottom:12px}
.dhikr-ar{font-family:‘Amiri’,serif;font-size:1.75rem;color:var(–gold2);margin-bottom:3px}
.dhikr-fr-txt{font-size:.74rem;color:var(–muted2);margin-bottom:16px}
.dhikr-tap{width:110px;height:110px;border-radius:50%;margin:0 auto 14px;cursor:pointer;position:relative;-webkit-user-select:none;user-select:none}
.dhikr-tap:active{transform:scale(.94)}
.dhikr-count-num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:‘Amiri’,serif;font-size:2.4rem;color:#fff;z-index:1}
.dhikr-target-txt{font-size:.68rem;color:var(–muted);margin-bottom:14px}
.dhikr-btn-row{display:flex;gap:8px;justify-content:center}

/* ── LEADERBOARD ── */
.lb-card{background:var(–card);border:1px solid var(–border);border-radius:14px;padding:14px;margin-bottom:8px;display:flex;align-items:center;gap:12px}
.lb-card.me{border-color:rgba(212,168,67,.3);background:rgba(212,168,67,.04)}
.lb-rank{font-family:‘Amiri’,serif;font-size:1.5rem;color:var(–muted);width:28px;text-align:center;flex-shrink:0}
.lb-av{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.82rem;flex-shrink:0}
.lb-info{flex:1}
.lb-name{font-weight:600;font-size:.84rem}
.lb-pts{font-size:.68rem;color:var(–muted2)}
.lb-nour{font-family:‘Amiri’,serif;font-size:1.4rem;color:var(–gold2)}
.lb-nour-lbl{font-size:.56rem;color:var(–muted)}
.badges-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
@media(max-width:380px){.badges-grid{grid-template-columns:repeat(2,1fr)}}
.badge-card{background:var(–card);border:1px solid var(–border);border-radius:12px;padding:12px;text-align:center}
.badge-card.unlocked{border-color:rgba(212,168,67,.3);background:var(–gold3)}
.badge-card.locked{opacity:.3;filter:grayscale(.9)}
.bc-icon{margin-bottom:5px;display:flex;justify-content:center;color:var(–gold)}
.bc-name{font-size:.68rem;font-weight:600}
.bc-req{font-size:.58rem;color:var(–muted2);margin-top:2px}

/* ── MODAL / TOAST ── */
.modal-bg{position:fixed;inset:0;z-index:150;background:rgba(7,9,15,.8);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;padding:16px}
.modal{background:var(–deep);border:1px solid rgba(212,168,67,.22);border-radius:20px;padding:24px;width:100%;max-width:320px;text-align:center;animation:modalIn .3s ease}
@keyframes modalIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
.modal h2{font-family:‘Amiri’,serif;font-size:1.4rem;color:var(–gold2);margin-bottom:5px}
.modal p{font-size:.78rem;color:var(–muted2);line-height:1.55;margin-bottom:16px}
.badge-icon-modal{display:flex;justify-content:center;margin-bottom:8px;animation:badgePop .55s cubic-bezier(.34,1.56,.64,1)}
@keyframes badgePop{from{transform:scale(0) rotate(-20deg)}to{transform:scale(1) rotate(0)}}
.modal-close{background:none;border:1px solid var(–border);color:var(–muted2);border-radius:999px;padding:7px 20px;font-size:.72rem;cursor:pointer;transition:all .2s}
.modal-close:hover{border-color:var(–gold);color:var(–gold)}
.toast{position:fixed;bottom:calc(16px + var(–safe-bottom));left:50%;transform:translateX(-50%) translateY(60px);background:var(–card2);border:1px solid rgba(212,168,67,.25);color:var(–text);padding:8px 18px;border-radius:999px;font-size:.74rem;z-index:300;transition:transform .3s ease;white-space:nowrap;pointer-events:none}
.toast.show{transform:translateX(-50%) translateY(0)}

/* ── GAME INVITE ── */
.invite-card{background:var(–card);border:1px solid rgba(19,181,164,.25);border-radius:14px;padding:14px;margin-bottom:10px}
.invite-card-title{font-size:.65rem;letter-spacing:2px;text-transform:uppercase;color:var(–teal2);margin-bottom:8px;display:flex;align-items:center;gap:6px}
</style>

</head>
<body>
<div id="sky"><div class="moon"></div></div>

<!-- LOGIN -->

<div id="login-screen">
  <div class="lcard">
    <div class="lcard-top">
      <div class="la">سكينة</div>
      <h1>Sakina Space</h1>
      <div class="ls">Ton espace spirituel partagé</div>
    </div>
    <label class="lbl">Ton prénom</label>
    <input class="li" id="ln" type="text" placeholder="Ex: Amina" maxlength="16">
    <label class="lbl">Code de l'espace</label>
    <input class="li" id="lcode" type="text" placeholder="Ex: LUNA2025 · FAMILLE · NOUR" maxlength="20" style="letter-spacing:2px;text-transform:uppercase" onkeydown="if(event.key==='Enter')goToRoom()">
    <div class="hint">
      <strong>Comment ça marche</strong><br>
      Invente un code et partage-le avec les personnes que tu veux inviter — amis, frères, sœurs, famille…
    </div>
    <button class="btn-gold" onclick="goToRoom()">Entrer dans l'espace</button>
  </div>
</div>

<!-- APP -->

<div id="app" style="display:none">
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:8px">
      <div class="tb-logo">Sakina</div>
      <div class="tb-level" id="tb-level">Mubtadi</div>
    </div>
    <div class="tb-nour">
      <svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
      <span class="tb-nour-val" id="tb-nour">0</span> Nour
    </div>
    <div style="display:flex;align-items:center;gap:6px">
      <div id="av-wrap" style="display:flex"></div>
      <div class="online-badge" id="online-badge">
        <div class="live-dot"></div>
        <span id="online-count">1</span>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="sidebar">
      <div class="stitle">Principal</div>
      <div class="ni active" id="nav-home" onclick="showPanel('home')">
        <span class="ni-icon"><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></span>
        <span class="nlabel">Accueil</span>
      </div>
      <div class="ni" id="nav-chat" onclick="showPanel('chat')">
        <span class="ni-icon"><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span>
        <span class="nlabel">Chat</span>
        <span class="nbadge" id="chat-badge" style="display:none">0</span>
      </div>
      <div class="stitle" style="margin-top:6px">Jeux</div>
      <div class="ni" id="nav-quiz" onclick="showPanel('quiz')">
        <span class="ni-icon"><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></span>
        <span class="nlabel">Quiz</span>
      </div>
      <div class="ni" id="nav-sprint" onclick="showPanel('sprint')">
        <span class="ni-icon"><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></span>
        <span class="nlabel">Sprint 30s</span>
      </div>
      <div class="ni" id="nav-memory" onclick="showPanel('memory')">
        <span class="ni-icon"><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></span>
        <span class="nlabel">Memory Dhikr</span>
      </div>
      <div class="ni" id="nav-wordsearch" onclick="showPanel('wordsearch')">
        <span class="ni-icon"><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span>
        <span class="nlabel">Mots mêlés</span>
      </div>
      <div class="stitle" style="margin-top:6px">Spirituel</div>
      <div class="ni" id="nav-hadith" onclick="showPanel('hadith')">
        <span class="ni-icon"><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg></span>
        <span class="nlabel">Hadiths</span>
      </div>
      <div class="ni" id="nav-dua" onclick="showPanel('dua')">
        <span class="ni-icon"><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg></span>
        <span class="nlabel">Douaas</span>
      </div>
      <div class="ni" id="nav-dhikr" onclick="showPanel('dhikr')">
        <span class="ni-icon"><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg></span>
        <span class="nlabel">Dhikr</span>
      </div>
      <div class="stitle" style="margin-top:6px">Classement</div>
      <div class="ni" id="nav-leaderboard" onclick="showPanel('leaderboard')">
        <span class="ni-icon"><svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></span>
        <span class="nlabel">Classement</span>
      </div>
    </div>

```
<div class="content">

  <!-- HOME -->
  <div class="panel active" id="panel-home">
    <div class="scroll-area">
      <div class="home-banner">
        <div class="hb-ar">بِسْمِ اللهِ الرَّحْمَٰنِ الرَّحِيمِ</div>
        <div class="hb-en">Sakina Space</div>
        <div class="hb-sub" id="home-welcome">Bienvenue</div>
      </div>
      <div class="nour-wrap">
        <div class="nour-row">
          <div><div class="nour-label">Points de Nour</div><div id="level-name" style="font-size:.7rem;color:var(--muted2);margin-top:2px"></div></div>
          <div style="text-align:right"><div class="nour-pts" id="home-nour">0</div><div style="font-size:.58rem;color:var(--muted)">pts total</div></div>
        </div>
        <div class="prog-bar"><div class="prog-fill pb-gold" id="nour-bar-fill" style="width:0%"></div></div>
        <div class="level-info"><span id="level-from">0</span><span id="level-next-name" style="color:var(--gold);font-size:.62rem"></span><span id="level-to">100</span></div>
      </div>
      <div class="section-title">Mini-jeux</div>
      <div class="games-grid">
        <div class="gc" style="--gca:var(--gold)" onclick="showPanel('quiz')"><div class="gc-glow"></div><div class="gc-icon"><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div><div class="gc-title">Quiz Islam</div><div class="gc-sub">50+ questions · multi</div><div class="gc-nour">+50 Nour</div></div>
        <div class="gc" style="--gca:var(--rose2)" onclick="showPanel('sprint')"><div class="gc-glow"></div><div class="gc-icon" style="color:var(--rose2)"><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div><div class="gc-title">Sprint 30s</div><div class="gc-sub">Max de réponses</div><div class="gc-nour">+10/rép</div></div>
        <div class="gc" style="--gca:var(--teal2)" onclick="showPanel('memory')"><div class="gc-glow"></div><div class="gc-icon" style="color:var(--teal2)"><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></div><div class="gc-title">Memory Dhikr</div><div class="gc-sub">Fais ton dhikr en jouant</div><div class="gc-nour">+15/paire</div></div>
        <div class="gc" style="--gca:var(--purple2)" onclick="showPanel('wordsearch')"><div class="gc-glow"></div><div class="gc-icon" style="color:var(--purple2)"><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div><div class="gc-title">Mots mêlés</div><div class="gc-sub">Mots islamiques</div><div class="gc-nour">+35/mot</div></div>
      </div>
      <div class="ayah-box">
        <div class="ayah-lbl">Verset du jour</div>
        <div class="ayah-ar" id="aw-ar"></div>
        <div class="ayah-fr" id="aw-fr"></div>
        <div class="ayah-ref" id="aw-ref"></div>
      </div>
      <div class="section-title">Ma progression</div>
      <div class="card" style="margin-bottom:14px">
        <div class="stat-grid">
          <div class="stat-item"><div class="stat-lbl">Quiz</div><div class="stat-val" id="stat-quiz">0</div><div class="prog-bar" style="margin-top:3px"><div class="prog-fill pb-gold" id="pf-quiz" style="width:0%"></div></div></div>
          <div class="stat-item"><div class="stat-lbl">Hadiths</div><div class="stat-val" id="stat-hadith">0</div><div class="prog-bar" style="margin-top:3px"><div class="prog-fill pb-teal" id="pf-hadith" style="width:0%"></div></div></div>
          <div class="stat-item"><div class="stat-lbl">Dhikr total</div><div class="stat-val" id="stat-dhikr">0</div><div class="prog-bar" style="margin-top:3px"><div class="prog-fill pb-rose" id="pf-dhikr" style="width:0%"></div></div></div>
          <div class="stat-item"><div class="stat-lbl">Mots trouvés</div><div class="stat-val" id="stat-words">0</div><div class="prog-bar" style="margin-top:3px"><div class="prog-fill pb-purple" id="pf-words" style="width:0%"></div></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- CHAT -->
  <div class="panel" id="panel-chat">
    <div class="chat-wrap">
      <div class="chat-msgs" id="chat-msgs">
        <div class="msg-sys">Assalamu Alaykoum — Bienvenue dans Sakina Space</div>
      </div>
      <div class="chat-quickbtns">
        <button class="qb" onclick="quickSend('Assalamu alaykoum')"><svg class="icon" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>Salam</button>
        <button class="qb" onclick="quickSend('Alhamdulillah')"><svg class="icon" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>Hamdellah</button>
        <button class="qb" onclick="quickSend('Machallah !')"><svg class="icon" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>Machallah</button>
        <button class="qb" onclick="sendGameInvite('quiz')"><svg class="icon" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>Inviter Quiz</button>
      </div>
      <div class="chat-input-row">
        <input class="chat-input" id="chat-inp" placeholder="Écris un message…" onkeydown="if(event.key==='Enter')sendChat()">
        <button class="send-btn" onclick="sendChat()">
          <svg class="icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- QUIZ -->
  <div class="panel" id="panel-quiz" style="position:relative">
    <div class="quiz-header" id="quiz-header" style="display:none">
      <div class="quiz-scoreline">
        <div class="qsc"><div class="qsc-name gold" id="qn1">Moi</div><div class="qsc-val" id="qs1">0</div></div>
        <div class="qsc-sep">✦</div>
        <div class="qsc"><div class="qsc-name" id="qn2">Solo</div><div class="qsc-val" id="qs2">—</div></div>
      </div>
      <div class="qprogress"><div class="qprogress-fill" id="qpf" style="width:0%"></div></div>
    </div>
    <div class="quiz-body" id="quiz-body">
      <div class="start-screen">
        <div class="start-icon"><svg class="icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div>
        <div class="start-title">Quiz Islam</div>
        <div class="start-desc">20 questions variées sur l'Islam.<br>Bonne réponse = +50 Nour<br><span style="color:var(--teal2)">Invite quelqu'un via le chat pour jouer en temps réel !</span></div>
        <button class="btn-gold" style="max-width:220px;margin:0 auto 10px" onclick="startQuiz(false)">Jouer en solo</button>
        <button class="btn-teal" style="max-width:220px;margin:0 auto" onclick="sendGameInvite('quiz');showPanel('chat')">Inviter quelqu'un</button>
      </div>
    </div>
  </div>

  <!-- SPRINT -->
  <div class="panel" id="panel-sprint">
    <div class="scroll-area" id="sprint-wrap">
      <div class="start-screen">
        <div class="start-icon"><svg class="icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--rose2)" stroke-width="1.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
        <div class="start-title">Sprint 30 secondes</div>
        <div class="start-desc">Max de questions en 30s.<br>+10 Nour par bonne réponse</div>
        <button class="btn-ghost" style="max-width:200px;margin:0 auto;border-color:var(--rose);color:var(--rose2)" onclick="startSprint()">Lancer</button>
      </div>
    </div>
  </div>

  <!-- MEMORY -->
  <div class="panel" id="panel-memory">
    <div class="scroll-area" id="memory-wrap">
      <div class="start-screen">
        <div class="start-icon"><svg class="icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--teal2)" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></div>
        <div class="start-title">Memory Dhikr</div>
        <div class="start-desc">Associe le dhikr en arabe ↔ sa traduction.<br>Fais ton dhikr en jouant !<br>+15 Nour par paire trouvée</div>
        <button class="btn-teal" style="max-width:200px;margin:0 auto" onclick="startMemory()">Commencer</button>
      </div>
    </div>
  </div>

  <!-- WORD SEARCH -->
  <div class="panel" id="panel-wordsearch">
    <div class="scroll-area" id="ws-wrap">
      <div class="start-screen">
        <div class="start-icon"><svg class="icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--purple2)" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>
        <div class="start-title">Mots mêlés</div>
        <div class="start-desc">Retrouve les mots islamiques dans la grille.<br>+35 Nour par mot</div>
        <button class="btn-ghost" style="max-width:200px;margin:0 auto;border-color:var(--purple);color:var(--purple2)" onclick="startWS()">Lancer la grille</button>
      </div>
    </div>
  </div>

  <!-- HADITH -->
  <div class="panel" id="panel-hadith"><div class="scroll-area"><div class="panel-title">Hadiths</div><div class="panel-sub">Clique pour développer · +5 Nour par hadith lu</div><div id="hadith-list"></div></div></div>

  <!-- DUA -->
  <div class="panel" id="panel-dua"><div class="scroll-area"><div class="panel-title">Douaas</div><div class="panel-sub">Invocations essentielles</div><div class="dua-cats" id="dua-cats"></div><div id="dua-list"></div></div></div>

  <!-- DHIKR -->
  <div class="panel" id="panel-dhikr">
    <div class="scroll-area">
      <div class="panel-title">Dhikr</div>
      <div style="margin-bottom:14px"></div>
      <div class="dhikr-select" id="dhikr-select"></div>
      <div class="dhikr-display">
        <div class="dhikr-ar" id="dhikr-ar">سُبْحَانَ اللهِ</div>
        <div class="dhikr-fr-txt" id="dhikr-fr-txt">Gloire à Allah</div>
        <div class="dhikr-tap" id="dhikr-tap" onclick="tapDhikr()">
          <svg style="position:absolute;inset:0;width:100%;height:100%;transform:rotate(-90deg)" viewBox="0 0 110 110">
            <circle cx="55" cy="55" r="48" fill="none" stroke="rgba(255,255,255,.06)" stroke-width="7"/>
            <circle id="dhikr-ring" cx="55" cy="55" r="48" fill="none" stroke="var(--gold)" stroke-width="7" stroke-linecap="round" stroke-dasharray="301.6" stroke-dashoffset="301.6" style="transition:stroke-dashoffset .3s ease"/>
          </svg>
          <div style="position:absolute;inset:8px;border-radius:50%;background:var(--card)"></div>
          <div class="dhikr-count-num" id="dhikr-count">0</div>
        </div>
        <div class="dhikr-target-txt" id="dhikr-target">0 / 33</div>
        <div class="dhikr-btn-row">
          <button class="btn-sm" onclick="undoDhikr()">Annuler</button>
          <button class="btn-sm" onclick="resetDhikr()" style="color:var(--rose2)">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div class="panel" id="panel-leaderboard">
    <div class="scroll-area">
      <div class="panel-title">Classement</div>
      <div class="panel-sub" id="lb-code-sub">Espace</div>
      <div id="lb-list"></div>
      <div style="margin-top:16px"><div class="section-title">Badges spirituels</div><div class="badges-grid" id="badges-grid"></div></div>
    </div>
  </div>
</div>
```

  </div>
</div>

<!-- BADGE MODAL -->

<div class="modal-bg" id="badge-modal" style="display:none" onclick="closeModal('badge-modal')">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="badge-icon-modal" id="bm-icon"></div>
    <h2 id="bm-name">Badge débloqué !</h2>
    <p id="bm-desc"></p>
    <button class="modal-close" onclick="closeModal('badge-modal')">Continuer</button>
  </div>
</div>
<div class="toast" id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>

<script>
/* ════════════════════ DATA ════════════════════ */
const LEVELS=[
  {name:'Mubtadi',min:0},{name:'Taalib',min:100},{name:'Moujtahid',min:300},
  {name:'Hafidh',min:600},{name:'Aalim',min:1000},{name:'Zaahid',min:1500},
  {name:'Wali',min:2200}
];
const BADGES=[
  {id:'first_quiz',name:'Premier Quiz',req:'Terminer ton premier quiz',svgKey:'quiz',cond:s=>s.quizDone>=1},
  {id:'quiz5',name:'Assidu',req:'5 quiz terminés',svgKey:'quiz',cond:s=>s.quizDone>=5},
  {id:'sprint_ace',name:'Sprint Ace',req:'Score Sprint ≥ 8',svgKey:'sprint',cond:s=>s.sprintBest>=8},
  {id:'memory_done',name:'Mémoire de fer',req:'Compléter le Memory Dhikr',svgKey:'mem',cond:s=>s.memoryDone>=1},
  {id:'word5',name:'Chasseur de mots',req:'5 mots trouvés',svgKey:'search',cond:s=>s.wordsFound>=5},
  {id:'hadith5',name:'Explorateur',req:'5 hadiths lus',svgKey:'book',cond:s=>s.hadithRead>=5},
  {id:'dhikr100',name:'100 Dhikr',req:'100 dhikr accomplis',svgKey:'circle',cond:s=>s.dhikrTotal>=100},
  {id:'nour500',name:'Étoile montante',req:'500 Nour',svgKey:'star',cond:s=>s.nour>=500},
  {id:'nour2k',name:'Lumière divine',req:'2000 Nour',svgKey:'star',cond:s=>s.nour>=2000},
];
const BADGE_SVGS={
  quiz:'<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
  sprint:'<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--rose2)" stroke-width="1.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
  mem:'<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--teal2)" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2"/></svg>',
  search:'<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--purple2)" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>',
  book:'<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
  circle:'<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--teal2)" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>',
  star:'<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>',
};

// 55 questions
const QUIZ_DATA=[
  {q:"Combien de piliers a l'Islam ?",a:["3","4","5","6"],c:2,cat:"Piliers",expl:"Les 5 piliers : Chahada, Salat, Zakat, Sawm, Hajj."},
  {q:"Quel est le 9ème mois du calendrier islamique ?",a:["Rajab","Chawwal","Dhul-Hijja","Ramadan"],c:3,cat:"Ramadan",expl:"Ramadan est le 9ème mois hégirien."},
  {q:"Quelle est la première sourate du Coran ?",a:["Al-Baqara","Yassine","Al-Fatiha","An-Nas"],c:2,cat:"Coran",expl:"Al-Fatiha (L'Ouverture) compte 7 versets."},
  {q:"Combien de sourates contient le Coran ?",a:["99","100","114","120"],c:2,cat:"Coran",expl:"Le Coran contient 114 sourates."},
  {q:"Quel ange a transmis le Coran ?",a:["Mikail","Israfil","Azrael","Djibril"],c:3,cat:"Coran",expl:"Djibril (Gabriel) a révélé le Coran sur 23 ans."},
  {q:"Quel prophète a construit une arche ?",a:["Ibrahim","Musa","Nouh","Dawud"],c:2,cat:"Prophètes",expl:"Nouh (Noé) construisit l'arche pour le déluge."},
  {q:"Dans quelle ville est né le Prophète ﷺ ?",a:["Médine","La Mecque","Taïf","Jérusalem"],c:1,cat:"Histoire",expl:"Né à La Mecque vers 570 apr. J.-C."},
  {q:"En quelle année a eu lieu l'Hégire ?",a:["610","622","632","640"],c:1,cat:"Histoire",expl:"En 622, migration de La Mecque vers Médine."},
  {q:"Comment s'appelle la rupture du jeûne ?",a:["Suhur","Tarawih","Iftar","Qiyam"],c:2,cat:"Ramadan",expl:"L'Iftar se fait au coucher du soleil."},
  {q:"Quel prophète a reçu la Torah ?",a:["Ibrahim","Dawud","Musa","Issa"],c:2,cat:"Prophètes",expl:"Musa (Moïse) a reçu la Torah sur le mont Sinaï."},
  {q:"Quelle nuit vaut mieux que mille mois ?",a:["Nuit de l'Hégire","Laylat al-Qadr","Nuit de l'Aïd","Nuit de Badr"],c:1,cat:"Ramadan",expl:"Laylat al-Qadr est dans les 10 derniers jours."},
  {q:"Que signifie 'Inshallah' ?",a:["Merci à Dieu","Si Dieu le veut","Gloire à Dieu","Dieu est grand"],c:1,cat:"Vocabulaire",expl:"Inshallah = Si Allah le veut."},
  {q:"Quel prophète est né sans père ?",a:["Yahya","Yunus","Issa","Idris"],c:2,cat:"Prophètes",expl:"Issa (Jésus) est né de la Vierge Maryam."},
  {q:"Combien de fois par jour le croyant prie-t-il ?",a:["3","4","5","7"],c:2,cat:"Piliers",expl:"5 prières : Fajr, Dhuhr, Asr, Maghrib, Isha."},
  {q:"Quel est le taux de la Zakat ?",a:["1%","2,5%","5%","10%"],c:1,cat:"Piliers",expl:"La Zakat est de 2,5% des économies."},
  {q:"Quelle sourate est surnommée cœur du Coran ?",a:["Al-Fatiha","Al-Baqara","Yassine","Al-Kahf"],c:2,cat:"Coran",expl:"La sourate Yassine (36) est le cœur du Coran."},
  {q:"Avec quoi rompt-on traditionnellement le jeûne ?",a:["Du pain","De la soupe","Des dattes","Du lait"],c:2,cat:"Ramadan",expl:"Le Prophète ﷺ rompait le jeûne avec des dattes."},
  {q:"Comment s'appelle le repas avant l'aube ?",a:["Iftar","Suhur","Tarawih","Witr"],c:1,cat:"Ramadan",expl:"Le Suhur est béni, ne le manque pas !"},
  {q:"Combien de juz' compte le Coran ?",a:["10","20","30","40"],c:2,cat:"Coran",expl:"30 juz' — un par jour pendant le Ramadan."},
  {q:"Comment s'appelle la prière nocturne du Ramadan ?",a:["Tahajjud","Duha","Tarawih","Witr"],c:2,cat:"Ramadan",expl:"La Tarawih est accomplie en groupe après Isha."},
  {q:"Que signifie 'Subhanallah' ?",a:["Dieu est grand","Gloire à Dieu","Louange à Dieu","Il n'y a de dieu qu'Allah"],c:1,cat:"Vocabulaire",expl:"Subhanallah = Gloire à Allah."},
  {q:"Que signifie 'Alhamdulillah' ?",a:["Gloire à Dieu","Si Dieu le veut","Louange à Dieu","Dieu est grand"],c:2,cat:"Vocabulaire",expl:"Alhamdulillah = Toute louange est due à Allah."},
  {q:"Que signifie 'Allahu Akbar' ?",a:["Gloire à Dieu","Allah est le Plus Grand","Il n'y a de dieu qu'Allah","Louange à Dieu"],c:1,cat:"Vocabulaire",expl:"Allahu Akbar = Allah est le Plus Grand."},
  {q:"Combien de prophètes sont mentionnés dans le Coran ?",a:["15","20","25","30"],c:2,cat:"Prophètes",expl:"25 prophètes sont nommés dans le Coran."},
  {q:"Quel est le premier pilier de l'Islam ?",a:["La prière","Le jeûne","La Chahada","Le pèlerinage"],c:2,cat:"Piliers",expl:"La Chahada : 'Il n'y a de dieu qu'Allah et Muhammad est son Messager.'"},
  {q:"Vers quelle direction les musulmans se tournent pour prier ?",a:["Médine","Jérusalem","La Mecque","Le Caire"],c:2,cat:"Piliers",expl:"La Qibla pointe vers la Kaaba à La Mecque."},
  {q:"Comment s'appelle le pèlerinage à La Mecque ?",a:["Zakat","Umra","Hajj","Sawm"],c:2,cat:"Piliers",expl:"Le Hajj est le 5ème pilier, obligatoire une fois dans sa vie."},
  {q:"Quel est le livre sacré des musulmans ?",a:["La Bible","La Torah","Le Coran","Les Psaumes"],c:2,cat:"Coran",expl:"Le Coran a été révélé au Prophète Muhammad ﷺ."},
  {q:"Comment s'appelle la mosquée la plus sacrée de l'Islam ?",a:["Masjid al-Aqsa","Masjid an-Nabawi","Masjid al-Haram","Masjid Quba"],c:2,cat:"Histoire",expl:"Masjid al-Haram à La Mecque est la plus sacrée."},
  {q:"Quel est le mois du pèlerinage ?",a:["Ramadan","Rajab","Dhul-Hijja","Muharram"],c:2,cat:"Histoire",expl:"Le Hajj se déroule pendant le mois de Dhul-Hijja."},
  {q:"Quel prophète est considéré comme le père des prophètes ?",a:["Adam","Nouh","Ibrahim","Muhammad"],c:2,cat:"Prophètes",expl:"Ibrahim (Abraham) est appelé le Khalil (ami d'Allah)."},
  {q:"Combien de fois la prière du vendredi (Jum'a) est-elle obligatoire ?",a:["Jamais","Une fois par jour","Une fois par semaine","Une fois par mois"],c:2,cat:"Piliers",expl:"La Jum'a remplace le Dhuhr chaque vendredi."},
  {q:"Quel est le nom arabe de Jésus ?",a:["Issa","Yahya","Musa","Ibrahim"],c:0,cat:"Prophètes",expl:"Issa (Jésus) est un prophète de l'Islam."},
  {q:"Combien de fois par an le jeûne de Ramadan est-il obligatoire ?",a:["Une fois par semaine","Une fois par an","Deux fois par an","Jamais"],c:1,cat:"Ramadan",expl:"Le jeûne de Ramadan est un pilier annuel de l'Islam."},
  {q:"Quel prophète a survécu dans le ventre d'une baleine ?",a:["Dawud","Yunus","Musa","Ismail"],c:1,cat:"Prophètes",expl:"Yunus (Jonas) a passé 40 jours dans le ventre d'une baleine."},
  {q:"Quelle est la plus grande sourate du Coran ?",a:["Al-Fatiha","Al-Imran","Al-Baqara","An-Nisa"],c:2,cat:"Coran",expl:"Al-Baqara contient 286 versets, la plus longue sourate."},
  {q:"Combien de versets contient Al-Fatiha ?",a:["5","6","7","8"],c:2,cat:"Coran",expl:"Al-Fatiha compte 7 versets, récités dans chaque rakaat."},
  {q:"Comment s'appelle l'ablution en islam ?",a:["Tayammum","Wudu","Ghusl","Istainja"],c:1,cat:"Piliers",expl:"Le Wudu est l'ablution mineure avant la prière."},
  {q:"Quel est le nom de la femme du Prophète ﷺ, mère des croyants la plus célèbre ?",a:["Fatima","Khadija","Aïcha","Zaynab"],c:1,cat:"Histoire",expl:"Khadija fut la première épouse du Prophète ﷺ et la première musulmane."},
  {q:"Quel est le premier mois du calendrier islamique ?",a:["Ramadan","Dhul-Hijja","Muharram","Rajab"],c:2,cat:"Histoire",expl:"Muharram est le premier mois de l'année hégirienne."},
  {q:"Que signifie 'Islam' en arabe ?",a:["Paix","Soumission","Foi","Justice"],c:1,cat:"Vocabulaire",expl:"Islam signifie soumission (à la volonté d'Allah), et induit la paix."},
  {q:"Comment s'appelle la Pierre noire de La Mecque ?",a:["Al-Maqam","Al-Hajar al-Aswad","As-Safa","Al-Kaaba"],c:1,cat:"Histoire",expl:"Al-Hajar al-Aswad est enchâssée dans un coin de la Kaaba."},
  {q:"Combien de rakaat contient la prière Fajr ?",a:["2","3","4","5"],c:0,cat:"Piliers",expl:"Fajr = 2 rakaat obligatoires (+ 2 sunnah)."},
  {q:"Combien de rakaat contient la prière Maghrib ?",a:["2","3","4","5"],c:1,cat:"Piliers",expl:"Maghrib = 3 rakaat obligatoires."},
  {q:"Comment s'appelle le prophète qui a pu parler aux animaux ?",a:["Dawud","Nouh","Sulayman","Ibrahim"],c:2,cat:"Prophètes",expl:"Sulayman (Salomon) pouvait parler aux oiseaux et aux animaux."},
  {q:"Quel est le nom arabe de Marie, mère de Jésus ?",a:["Fatima","Khadija","Maryam","Asiya"],c:2,cat:"Coran",expl:"Maryam est la seule femme dont le nom est mentionné dans le Coran."},
  {q:"Quel prophète a été jeté dans le feu et n'a pas brûlé ?",a:["Musa","Issa","Ibrahim","Yunus"],c:2,cat:"Prophètes",expl:"Allah dit 'Ô feu, sois fraîcheur et paix pour Ibrahim'."},
  {q:"Que signifie 'Astaghfirullah' ?",a:["Dieu merci","Je demande pardon à Dieu","Gloire à Dieu","Que Dieu te bénisse"],c:1,cat:"Vocabulaire",expl:"Astaghfirullah = Je demande pardon à Allah."},
  {q:"Quel jour est considéré comme le plus sacré de la semaine ?",a:["Samedi","Dimanche","Lundi","Vendredi"],c:3,cat:"Piliers",expl:"Le vendredi (Yawm al-Jum'a) est le maître des jours."},
  {q:"Quel est le nombre de Noms d'Allah mentionnés dans le hadith des 99 noms ?",a:["33","66","99","100"],c:2,cat:"Vocabulaire",expl:"Allah a 99 Noms — celui qui les dénombre entre au Paradis."},
  {q:"Comment s'appelle le lieu sacré vers lequel les pèlerins se dirigent ?",a:["Arafat","Mina","La Kaaba","Muzdalifa"],c:2,cat:"Histoire",expl:"La Kaaba (Maison d'Allah) est le centre de la circumambulation."},
  {q:"Combien de fois les pèlerins tournent autour de la Kaaba ?",a:["3","5","7","9"],c:2,cat:"Histoire",expl:"Le Tawaf consiste en 7 circumambulations autour de la Kaaba."},
  {q:"Quel prophète a fendu la mer ?",a:["Ibrahim","Sulayman","Musa","Issa"],c:2,cat:"Prophètes",expl:"Musa a fendu la mer avec sa canne par la permission d'Allah."},
  {q:"Que signifie 'Barakallah fik' ?",a:["Que Dieu te pardonne","Que Dieu te bénisse","Dieu est grand","Gloire à Dieu"],c:1,cat:"Vocabulaire",expl:"Barakallah fik = Que la bénédiction d'Allah soit sur toi."},
  {q:"Dans quelle sourate trouve-t-on le Verset du Trône (Ayat al-Kursi) ?",a:["Al-Fatiha","Al-Baqara","Al-Imran","Yassine"],c:1,cat:"Coran",expl:"Ayat al-Kursi est le verset 255 de Al-Baqara."},
];

const DHIKR_MEMORY=[
  {ar:"سُبْحَانَ اللهِ",fr:"Gloire à Allah",ph:"Subhanallah"},
  {ar:"الْحَمْدُ لِلَّهِ",fr:"Louange à Allah",ph:"Alhamdulillah"},
  {ar:"اللهُ أَكْبَرُ",fr:"Allah est le Plus Grand",ph:"Allahu Akbar"},
  {ar:"لَا إِلَهَ إِلَّا اللهُ",fr:"Il n'y a de dieu qu'Allah",ph:"La ilaha illallah"},
  {ar:"أَسْتَغْفِرُ اللهَ",fr:"Je demande pardon à Allah",ph:"Astaghfirullah"},
  {ar:"بِسْمِ اللهِ",fr:"Au nom d'Allah",ph:"Bismillah"},
  {ar:"سُبْحَانَ اللهِ وَبِحَمْدِهِ",fr:"Gloire à Allah et Sa louange",ph:"Subhanallah wabihamdih"},
  {ar:"لَا حَوْلَ وَلَا قُوَّةَ إِلَّا بِاللهِ",fr:"Pas de force sauf par Allah",ph:"La hawla wala quwwata illa billah"},
];

const DHIKR_LIST=[
  {ar:"سُبْحَانَ اللهِ",fr:"Gloire à Allah",target:33},
  {ar:"الْحَمْدُ لِلَّهِ",fr:"Louange à Allah",target:33},
  {ar:"اللهُ أَكْبَرُ",fr:"Allah est le Plus Grand",target:33},
  {ar:"لَا إِلَهَ إِلَّا اللهُ",fr:"Il n'y a de dieu qu'Allah",target:100},
  {ar:"أَسْتَغْفِرُ اللهَ",fr:"Je demande pardon à Allah",target:100},
];

const HADITHS=[
  {num:1,ar:"مَنْ صَامَ رَمَضَانَ إِيمَانًا وَاحْتِسَابًا غُفِرَ لَهُ مَا تَقَدَّمَ مِنْ ذَنْبِهِ",fr:"Quiconque jeûne le Ramadan par foi et espérant la récompense, ses péchés passés lui seront pardonnés.",src:"Bukhari & Muslim",vertu:"Une des plus grandes promesses divines. Le jeûne sincère efface les péchés passés.",cat:"Ramadan"},
  {num:2,ar:"إِذَا جَاءَ رَمَضَانُ فُتِحَتْ أَبْوَابُ الْجَنَّةِ وَغُلِّقَتْ أَبْوَابُ جَهَنَّمَ",fr:"Lorsque vient le Ramadan, les portes du Paradis s'ouvrent et celles de l'Enfer se ferment.",src:"Bukhari & Muslim",vertu:"Ce mois est unique. Toutes les conditions sont réunies pour l'élévation spirituelle.",cat:"Ramadan"},
  {num:3,ar:"الصَّوْمُ جُنَّةٌ",fr:"Le jeûne est un bouclier.",src:"Bukhari",vertu:"Un seul mot, une immense sagesse. Le jeûne protège l'âme.",cat:"Ramadan"},
  {num:4,ar:"إِنَّمَا الأَعْمَالُ بِالنِّيَّاتِ",fr:"Les actes ne valent que par les intentions.",src:"Bukhari & Muslim",vertu:"L'intention pure transforme tout acte en adoration.",cat:"Fondements"},
  {num:5,ar:"الْمُسْلِمُ مَنْ سَلِمَ الْمُسْلِمُونَ مِنْ لِسَانِهِ وَيَدِهِ",fr:"Le musulman est celui dont les autres sont à l'abri de sa langue et de sa main.",src:"Bukhari",vertu:"Nuire par la parole ou l'action contredit l'essence de la foi.",cat:"Caractère"},
  {num:6,ar:"تَسَحَّرُوا فَإِنَّ فِي السَّحُورِ بَرَكَةً",fr:"Prenez le repas du Suhur, car dans ce repas il y a une bénédiction.",src:"Bukhari & Muslim",vertu:"Même quelques gorgées d'eau suffisent pour cette bénédiction.",cat:"Ramadan"},
  {num:7,ar:"لِلصَّائِمِ فَرْحَتَانِ عِنْدَ فِطْرِهِ وَعِنْدَ لِقَاءِ رَبِّهِ",fr:"Le jeûneur connaît deux joies : quand il rompt le jeûne et quand il rencontre son Seigneur.",src:"Bukhari & Muslim",vertu:"La joie de l'Iftar est belle. Mais la joie devant Allah sera infiniment plus grande.",cat:"Ramadan"},
  {num:8,ar:"خَيْرُكُمْ مَنْ تَعَلَّمَ الْقُرْآنَ وَعَلَّمَهُ",fr:"Le meilleur d'entre vous est celui qui apprend le Coran et l'enseigne.",src:"Bukhari",vertu:"Transmettre le Coran est l'une des meilleures actions.",cat:"Coran"},
];

const DUAS=[
  {cat:"Ramadan",sit:"Rupture du jeûne (Iftar)",ar:"اللَّهُمَّ لَكَ صُمْتُ وَعَلَى رِزْقِكَ أَفْطَرْتُ",ph:"Allahoumma laka soumtou wa ala rizqika aftartou",fr:"Ô Allah, c'est pour Toi que j'ai jeûné et avec Ta provision que je romps le jeûne.",src:"Abu Dawud"},
  {cat:"Ramadan",sit:"Vue du croissant de lune",ar:"اللَّهُمَّ أَهِلَّهُ عَلَيْنَا بِالأَمْنِ وَالإِيمَانِ",ph:"Allahoumma ahillahoo alayna bil-amni wal-eeymaan",fr:"Ô Allah, fais que ce croissant nous apporte sécurité et foi.",src:"Tirmidhi"},
  {cat:"Laylat al-Qadr",sit:"La Nuit du Destin",ar:"اللَّهُمَّ إِنَّكَ عَفُوٌّ تُحِبُّ الْعَفْوَ فَاعْفُ عَنِّي",ph:"Allahoumma innaka afouwoun touhibboul-afwa fafou anni",fr:"Ô Allah, Tu es Celui qui pardonne et Tu aimes pardonner, alors pardonne-moi.",src:"Tirmidhi"},
  {cat:"Quotidien",sit:"En se réveillant",ar:"الْحَمْدُ لِلَّهِ الَّذِي أَحْيَانَا بَعْدَ مَا أَمَاتَنَا",ph:"Alhamdulillahi alladhi ahyaana bada maa amaatanaa",fr:"Louange à Allah qui nous a fait revivre après nous avoir fait mourir.",src:"Bukhari"},
  {cat:"Quotidien",sit:"Avant de manger",ar:"بِسْمِ اللَّهِ وَعَلَى بَرَكَةِ اللَّهِ",ph:"Bismillahi wa ala barakati-llah",fr:"Au nom d'Allah et avec la bénédiction d'Allah.",src:"Abu Dawud"},
  {cat:"Protection",sit:"Protection contre tout mal",ar:"بِسْمِ اللَّهِ الَّذِي لا يَضُرُّ مَعَ اسْمِهِ شَيْءٌ",ph:"Bismillahi-lladhi laa yadurrou maa ismihi shayoun",fr:"Au nom d'Allah, avec Lequel rien ne peut nuire.",src:"Abu Dawud"},
  {cat:"Dua du soir",sit:"Avant de dormir",ar:"بِاسْمِكَ اللَّهُمَّ أَمُوتُ وَأَحْيَا",ph:"Bismikal-lahoumma amootu wa ahyaa",fr:"En Ton nom, ô Allah, je meurs et je vis.",src:"Bukhari"},
];

const WS_WORDS=['ALLAH','CORAN','RAMADAN','SALAT','ZAKAT','HAJJ','SAWM','SALAM','NOUR','TAWBAH','IMAN','WUDU','DEEN','DUAA','SABR'];

const AYAHS=[
  {ar:"شَهْرُ رَمَضَانَ الَّذِي أُنزِلَ فِيهِ الْقُرْآنُ",fr:"Le mois de Ramadan est celui durant lequel le Coran fut révélé.",ref:"Al-Baqara 2:185"},
  {ar:"وَإِذَا سَأَلَكَ عِبَادِي عَنِّي فَإِنِّي قَرِيبٌ",fr:"Quand Mes serviteurs t'interrogent sur Moi, alors Je suis proche.",ref:"Al-Baqara 2:186"},
  {ar:"إِنَّ اللَّهَ مَعَ الصَّابِرِينَ",fr:"Certes, Allah est avec les endurants.",ref:"Al-Baqara 2:153"},
  {ar:"وَعَسَىٰ أَن تَكْرَهُوا شَيْئًا وَهُوَ خَيْرٌ لَّكُمْ",fr:"Il se peut que vous ayez de l'aversion pour une chose alors qu'elle est un bien pour vous.",ref:"Al-Baqara 2:216"},
  {ar:"إِنَّ اللَّهَ لَا يُضِيعُ أَجْرَ الْمُحْسِنِينَ",fr:"Allah ne laisse pas perdre la récompense des bienfaisants.",ref:"Hud 11:115"},
  {ar:"فَإِنَّ مَعَ الْعُسْرِ يُسْرًا",fr:"Car après la difficulté vient la facilité.",ref:"Al-Inshirah 94:5"},
];

/* ════════════════════ STATE ════════════════════ */
let myName='',spaceCode='',db=null;
let unreadChat=0,inChat=false;
let dhikrIdx=0,dhikrCount=0;
// Quiz
let quizState=null,quizAnswered=false,quizSessionId=null,quizMulti=false;
let quizOtherScoreRef=null;
// Sprint
let sprintInterval=null,sprintActive=false,sprintScore=0,sprintTotal=0,sprintQIdx=0,sprintPool=[],sprintT=30;
// Memory
let memFlipped=[],memMatched=0,memCards=[],memLocked=false,memMoves=0,memTotal=0;
// Word search
let wsSelected=[],wsFound=[],wsGrid=[],wsWords=[],wsDragging=false,wsStartCell=null;
// Stats
let stats={nour:0,quizDone:0,hadithRead:0,dhikrTotal:0,wordsFound:0,sprintBest:0,memoryDone:0};
let earnedBadges=new Set();
let chatMsgKeys=new Set();

/* ════════════════════ UTILS ════════════════════ */
const shuffle=a=>{const b=[...a];for(let i=b.length-1;i>0;i--){const j=0|Math.random()*(i+1);[b[i],b[j]]=[b[j],b[i]];}return b};
const esc=t=>String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const tnow=()=>new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
function toast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800)}
function closeModal(id){document.getElementById(id).style.display='none'}
function spawnParticle(x,y){
  const p=document.createElement('div');p.className='particle';
  const sz=Math.random()*8+4;
  p.style.cssText=`width:${sz}px;height:${sz}px;left:${x}px;top:${y}px;background:${Math.random()>.5?'var(--gold)':'var(--teal2)'};opacity:.9;--dur:${.8+Math.random()}s`;
  document.body.appendChild(p);setTimeout(()=>p.remove(),1500);
}
const $=id=>document.getElementById(id);

/* ════════════════════ FIREBASE ════════════════════ */
function initFirebase(){
  try{
    const cfg={apiKey:"AIzaSyDNYqvNg6goVwEn-UJ5ll9ZKFMEqe7W4yA",authDomain:"ramadan-space.firebaseapp.com",databaseURL:"https://ramadan-space-default-rtdb.firebaseio.com",projectId:"ramadan-space"};
    if(!firebase.apps.length)firebase.initializeApp(cfg);
    db=firebase.database();
    db.ref('.info/connected').on('value',snap=>{
      if(snap.val()&&myName){
        listenChat();listenMembers();listenGameInvites();
      }
    });
  }catch(e){console.error('Firebase:',e)}
}

function listenChat(){
  if(!db)return;
  db.ref(`spaces/${spaceCode}/chat`).limitToLast(100).on('child_added',snap=>{
    const msg=snap.val();if(msg)appendChatMsg(msg,snap.key);
  });
}
function listenMembers(){
  if(!db)return;
  db.ref(`spaces/${spaceCode}/members/${myName}`).set({name:myName,ts:Date.now()});
  setInterval(()=>db&&db.ref(`spaces/${spaceCode}/members/${myName}`).update({ts:Date.now()}),25000);
  db.ref(`spaces/${spaceCode}/members`).on('value',snap=>{
    const active=Object.values(snap.val()||{}).filter(m=>Date.now()-m.ts<120000);
    renderAvatars(active);
  });
}

/* ════════ GAME INVITE / MULTIPLAYER ════════ */
function sendGameInvite(game){
  if(!db){toast('Connexion requise pour inviter');return}
  const inviteId='inv_'+Date.now();
  const inv={from:myName,game,inviteId,ts:Date.now()};
  db.ref(`spaces/${spaceCode}/invites/${inviteId}`).set(inv);
  // Post in chat
  const msg={from:myName,text:`__INVITE__${JSON.stringify(inv)}`,time:tnow(),ts:Date.now()};
  db.ref(`spaces/${spaceCode}/chat`).push(msg);
  toast('Invitation envoyée !');
}

function listenGameInvites(){
  if(!db)return;
  db.ref(`spaces/${spaceCode}/invites`).on('child_added',snap=>{
    const inv=snap.val();
    if(!inv||inv.from===myName)return;
    // already handled via chat bubble
  });
}

function acceptInvite(inviteId,game,fromUser){
  if(!db)return;
  db.ref(`spaces/${spaceCode}/invites/${inviteId}`).update({accepted:myName,acceptedTs:Date.now()});
  // Start a shared quiz session
  quizSessionId=inviteId;quizMulti=true;
  startQuiz(true,fromUser);
  showPanel('quiz');
  toast('Tu rejoins le quiz de '+fromUser+' !');
}

function listenQuizMulti(sessionId,otherName){
  if(!db)return;
  if(quizOtherScoreRef)quizOtherScoreRef.off();
  quizOtherScoreRef=db.ref(`spaces/${spaceCode}/quiz/${sessionId}/${otherName}`);
  quizOtherScoreRef.on('value',snap=>{
    const data=snap.val();
    if(!data)return;
    const el=$('qs2');if(!el)return;
    el.textContent=data.score||0;
    el.classList.add('score-flash');
    setTimeout(()=>el.classList.remove('score-flash'),400);
  });
  // Also listen for the invite accept (if I'm the inviter)
  db.ref(`spaces/${spaceCode}/invites/${sessionId}`).on('value',snap=>{
    const inv=snap.val();
    if(inv&&inv.accepted&&inv.accepted!==myName&&!quizMulti){
      quizMulti=true;
      $('qn2').textContent=inv.accepted;
      toast(inv.accepted+' a rejoint le quiz !');
      listenQuizMulti(sessionId,inv.accepted);
    }
  });
}

function pushQuizScore(score){
  if(!db||!quizSessionId)return;
  db.ref(`spaces/${spaceCode}/quiz/${quizSessionId}/${myName}`).update({score,ts:Date.now()});
}

/* ════════════════════ LOGIN ════════════════════ */
function goToRoom(){
  const name=$('ln').value.trim();
  const code=$('lcode').value.trim().toUpperCase().replace(/\s+/g,'');
  if(!name){toast('Entre ton prénom !');return}
  if(!code){toast('Entre un code d\'espace !');return}
  myName=name;spaceCode=code;
  localStorage.setItem('sk_name',name);localStorage.setItem('sk_code',code);
  loadStats();
  $('login-screen').style.display='none';
  $('app').style.display='flex';
  initApp();
}

function initApp(){
  setupStars();
  $('home-welcome').textContent='Bienvenue, '+myName;
  $('lb-code-sub').textContent='Espace : '+spaceCode;
  const a=AYAHS[new Date().getDate()%AYAHS.length];
  $('aw-ar').textContent=a.ar;$('aw-fr').textContent='« '+a.fr+' »';$('aw-ref').textContent='— '+a.ref;
  $('av-wrap').innerHTML=`<div class="av me">${myName.charAt(0).toUpperCase()}</div>`;
  renderHadiths();renderDuas();renderDhikrSelect();
  updateNourUI();updateStatsUI();
  initFirebase();
  // Handle keyboard on mobile — push content up
  if('visualViewport' in window){
    window.visualViewport.addEventListener('resize',handleVP);
    window.visualViewport.addEventListener('scroll',handleVP);
  }
}

function handleVP(){
  const vp=window.visualViewport;
  const offsetBottom=window.innerHeight-vp.height-vp.offsetTop;
  const rows=document.querySelectorAll('.chat-input-row');
  rows.forEach(r=>r.style.paddingBottom=Math.max(offsetBottom,parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-bottom'))||0)+'px');
}

function setupStars(){
  const sky=$('sky');
  for(let i=0;i<90;i++){
    const s=document.createElement('div');s.className='star';
    const sz=Math.random()*2.5+.5;
    s.style.cssText=`width:${sz}px;height:${sz}px;top:${Math.random()*75}%;left:${Math.random()*100}%;--op:${Math.random()*.5+.2};--d:${Math.random()*4+2}s;--dl:${Math.random()*4}s`;
    sky.appendChild(s);
  }
}

function renderAvatars(members){
  const w=$('av-wrap');
  w.innerHTML=`<div class="av me" title="${esc(myName)}">${myName.charAt(0).toUpperCase()}</div>`;
  members.filter(m=>m.name!==myName).slice(0,4).forEach(m=>{
    const d=document.createElement('div');d.className='av other';d.title=m.name;
    d.textContent=(m.name||'?').charAt(0).toUpperCase();w.appendChild(d);
  });
  $('online-count').textContent=members.length;
}

/* ════════════════════ NAVIGATION ════════════════════ */
function showPanel(id){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));
  $('panel-'+id).classList.add('active');
  $('nav-'+id).classList.add('active');
  inChat=(id==='chat');
  if(inChat){unreadChat=0;updateChatBadge()}
  if(id==='leaderboard')renderLeaderboard();
}
function updateChatBadge(){
  const b=$('chat-badge');
  if(unreadChat>0){b.style.display='flex';b.textContent=unreadChat}else b.style.display='none';
}

/* ════════════════════ GAMIFICATION ════════════════════ */
function getLevel(n){return LEVELS.slice().reverse().find(l=>n>=l.min)||LEVELS[0]}
function addNour(pts){stats.nour+=pts;saveStats();updateNourUI();checkBadges()}
function updateNourUI(){
  const n=stats.nour,lv=getLevel(n);
  const lvIdx=LEVELS.indexOf(lv);const lvN=LEVELS[lvIdx+1];
  const pct=lvN?Math.min((n-lv.min)/(lvN.min-lv.min)*100,100):100;
  const set=(id,v)=>{const e=$(id);if(e)e.textContent=v};
  set('tb-nour',n);set('tb-level',lv.name);set('home-nour',n);
  set('level-name','Niveau : '+lv.name);set('level-from',lv.min);
  set('level-to',lvN?lvN.min:'MAX');set('level-next-name',lvN?'→ '+lvN.name:'');
  const f=$('nour-bar-fill');if(f)f.style.width=pct+'%';
}
function checkBadges(){
  for(const b of BADGES){
    if(!earnedBadges.has(b.id)&&b.cond(stats)){
      earnedBadges.add(b.id);
      $('bm-icon').innerHTML=BADGE_SVGS[b.svgKey]||'';
      $('bm-name').textContent=b.name;$('bm-desc').textContent=b.req;
      $('badge-modal').style.display='flex';break;
    }
  }
}
function saveStats(){
  localStorage.setItem('sk_stats_'+spaceCode,JSON.stringify(stats));
  if(db)db.ref(`spaces/${spaceCode}/scores/${myName}`).set({name:myName,nour:stats.nour,ts:Date.now()});
}
function loadStats(){
  const s=localStorage.getItem('sk_stats_'+spaceCode);
  if(s)stats={...stats,...JSON.parse(s)};
  earnedBadges=new Set();BADGES.forEach(b=>{if(b.cond(stats))earnedBadges.add(b.id)});
}
function updateStatsUI(){
  const set=(id,v)=>{const e=$(id);if(e)e.textContent=v};
  set('stat-quiz',stats.quizDone);set('stat-hadith',stats.hadithRead);
  set('stat-dhikr',stats.dhikrTotal);set('stat-words',stats.wordsFound);
  const pf=(id,v,mx)=>{const e=$(id);if(e)e.style.width=Math.min(v/mx*100,100)+'%'};
  pf('pf-quiz',stats.quizDone,20);pf('pf-hadith',stats.hadithRead,HADITHS.length);
  pf('pf-dhikr',stats.dhikrTotal,500);pf('pf-words',stats.wordsFound,50);
}

/* ════════════════════ CHAT ════════════════════ */
function sendChat(){
  const inp=$('chat-inp');const text=inp.value.trim();if(!text)return;inp.value='';
  const msg={from:myName,text,time:tnow(),ts:Date.now()};
  if(db)db.ref(`spaces/${spaceCode}/chat`).push(msg);
  else appendChatMsg(msg,'local_'+Date.now());
}
function quickSend(text){
  const msg={from:myName,text,time:tnow(),ts:Date.now()};
  if(db)db.ref(`spaces/${spaceCode}/chat`).push(msg);
  else appendChatMsg(msg,'local_'+Date.now());
}
function appendChatMsg(msg,key){
  if(key&&chatMsgKeys.has(key))return;
  if(key)chatMsgKeys.add(key);
  const c=$('chat-msgs');
  const atBot=c.scrollHeight-c.scrollTop<=c.clientHeight+80;
  const mine=msg.from===myName;
  // Game invite message
  if(msg.text&&msg.text.startsWith('__INVITE__')){
    try{
      const inv=JSON.parse(msg.text.replace('__INVITE__',''));
      const w=document.createElement('div');w.className='msg-wrap'+(mine?' mine':'');
      const alreadyJoined=mine;
      w.innerHTML=`<div class="m-av">${(msg.from||'?').charAt(0).toUpperCase()}</div>
<div style="flex:1"><div class="m-name">${esc(msg.from||'')}</div>
<div class="m-bubble invite-bubble">
<div style="font-size:.7rem;font-weight:700;margin-bottom:4px">Invitation au Quiz Islam</div>
<div style="font-size:.74rem;color:var(--muted2)">Joue en temps réel avec ${esc(inv.from)}</div>
${!alreadyJoined?`<button class="invite-btn" id="ibtn-${esc(inv.inviteId)}" onclick="acceptInvite('${esc(inv.inviteId)}','${esc(inv.game)}','${esc(inv.from)}');this.disabled=true;this.textContent='Rejoint !'">Rejoindre le quiz</button>`:'<div style="font-size:.7rem;color:var(--teal2);margin-top:6px">Invitation envoyée</div>'}
</div>
<div class="m-time">${msg.time||''}</div></div>`;
      c.appendChild(w);
      if(!inChat&&!mine){unreadChat++;updateChatBadge()}
      if(atBot)c.scrollTop=c.scrollHeight;
    }catch(e){}
    return;
  }
  const w=document.createElement('div');w.className='msg-wrap'+(mine?' mine':'');
  w.innerHTML=`<div class="m-av">${(msg.from||'?').charAt(0).toUpperCase()}</div>
<div><div class="m-name">${esc(msg.from||'')}</div>
<div class="m-bubble">${esc(msg.text)}</div>
<div class="m-time">${msg.time||''}</div></div>`;
  c.appendChild(w);
  if(!inChat&&!mine){unreadChat++;updateChatBadge()}
  if(atBot)c.scrollTop=c.scrollHeight;
}

/* ════════════════════ QUIZ ════════════════════ */
function startQuiz(multi=false,otherName=''){
  // Use a fresh shuffled pool each game — no repeats until all used
  const pool=shuffle([...QUIZ_DATA]);
  quizState={pool,cur:0,score:0,total:20,multi,otherName};
  quizAnswered=false;
  if(multi){
    quizSessionId=quizSessionId||('solo_'+Date.now());
    $('qn2').textContent=otherName||'Adversaire';
    listenQuizMulti(quizSessionId,otherName);
  }else{
    quizSessionId='solo_'+Date.now();
    $('qn2').textContent='—';$('qs2').textContent='—';
  }
  $('qn1').textContent=myName;$('qs1').textContent='0';
  $('quiz-header').style.display='block';
  $('qpf').style.width='0%';
  renderQuizQ();
}

function renderQuizQ(){
  const s=quizState;if(!s)return;
  if(s.cur>=s.total){renderQuizResult();return}
  const q=s.pool[s.cur],total=s.total;
  $('qs1').textContent=s.score;
  $('qpf').style.width=(s.cur/total*100)+'%';
  const letters=['A','B','C','D'];
  const si=shuffle([0,1,2,3]);
  let h=`<div class="q-card">
<div style="margin-bottom:6px"><span class="tag gold">${q.cat}</span> <span style="font-size:.65rem;color:var(--muted)">Q${s.cur+1}/${total}</span></div>
<div class="q-text">${esc(q.q)}</div></div>
<div class="q-answers">`;
  si.forEach((orig,i)=>{
    h+=`<button class="q-ans" onclick="answerQ(this,${orig},${q.c})" data-orig="${orig}"><span class="q-lbl">${letters[i]}</span>${esc(q.a[orig])}</button>`;
  });
  h+=`</div>`;
  $('quiz-body').innerHTML=h;
  quizAnswered=false;
}

function answerQ(btn,orig,correct){
  if(quizAnswered)return;quizAnswered=true;
  const ok=orig===correct;
  document.querySelectorAll('.q-ans').forEach(b=>{
    b.disabled=true;
    const o=parseInt(b.getAttribute('data-orig'));
    if(o===correct)b.classList.add(b===btn?'correct':'reveal');
    else if(b===btn)b.classList.add('wrong');
  });
  if(ok){
    quizState.score++;
    addNour(50);
    pushQuizScore(quizState.score);
    const el=$('qs1');el.textContent=quizState.score;
    el.classList.add('score-flash');setTimeout(()=>el.classList.remove('score-flash'),400);
    const r=btn.getBoundingClientRect();
    for(let i=0;i<7;i++)setTimeout(()=>spawnParticle(r.left+r.width/2+Math.random()*40-20,r.top+10),i*55);
  }
  const q=quizState.pool[quizState.cur];
  $('quiz-body').insertAdjacentHTML('beforeend',
    `<div class="q-expl show">— ${esc(q.expl)}</div><button class="q-next show" onclick="nextQ()">Suivant</button>`);
}

function nextQ(){
  quizState.cur++;
  if(quizState.cur>=quizState.total){renderQuizResult();return}
  renderQuizQ();
}

function renderQuizResult(){
  const score=quizState.score,total=quizState.total;
  stats.quizDone++;saveStats();updateStatsUI();checkBadges();
  $('quiz-header').style.display='none';
  $('qpf').style.width='100%';
  const msg=score>=16?'Mashallah, excellent !':score>=12?'Très bien !':score>=8?'Pas mal !':'Continue à apprendre !';
  $('quiz-body').innerHTML=`<div style="text-align:center;padding:24px 16px">
<div style="display:flex;justify-content:center;margin-bottom:12px"><svg class="icon" width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></div>
<div style="font-family:'Amiri',serif;font-size:1.6rem;color:var(--gold2)">${score} / ${total}</div>
<div style="font-size:.74rem;color:var(--muted2);margin:5px 0 20px">${msg} — +${score*50} Nour</div>
<button class="btn-gold" style="max-width:220px;margin:0 auto 10px" onclick="startQuiz(false)">Rejouer en solo</button>
<button class="btn-teal" style="max-width:220px;margin:0 auto" onclick="sendGameInvite('quiz');showPanel('chat')">Inviter quelqu'un</button>
</div>`;
  if(quizOtherScoreRef){quizOtherScoreRef.off();quizOtherScoreRef=null}
}

/* ════════════════════ SPRINT ════════════════════ */
function startSprint(){
  if(sprintInterval)clearInterval(sprintInterval);
  sprintScore=0;sprintTotal=0;sprintQIdx=0;sprintActive=true;sprintT=30;
  sprintPool=shuffle([...QUIZ_DATA]);
  renderSprintQ();
  sprintInterval=setInterval(()=>{
    sprintT--;
    const tn=$('timer-num'),tc=$('timer-circle');
    if(tn)tn.textContent=sprintT;
    if(tc)tc.style.strokeDashoffset=213.6*(1-sprintT/30);
    if(tn)tn.style.color=sprintT<=5?'var(--rose2)':'var(--rose)';
    if(sprintT<=0){clearInterval(sprintInterval);sprintActive=false;endSprint()}
  },1000);
}
function renderSprintQ(){
  if(!sprintActive)return;
  if(sprintQIdx>=sprintPool.length)sprintPool=shuffle([...QUIZ_DATA]);
  const q=sprintPool[sprintQIdx];
  const si=shuffle([0,1,2,3]);const letters=['A','B','C','D'];
  $('sprint-wrap').innerHTML=`<div class="sprint-score-bar">
<span style="font-size:.68rem;color:var(--muted)">Score</span>
<span style="font-family:'Amiri',serif;font-size:1.4rem;color:var(--gold2)">${sprintScore}</span>
<span style="font-size:.68rem;color:var(--muted)">Q${sprintTotal+1}</span></div>
<div class="timer-ring-wrap">
<svg width="80" height="80" viewBox="0 0 80 80">
<circle cx="40" cy="40" r="34" fill="none" stroke="rgba(255,255,255,.06)" stroke-width="5"/>
<circle id="timer-circle" cx="40" cy="40" r="34" fill="none" stroke="var(--rose)" stroke-width="5" stroke-linecap="round" stroke-dasharray="213.6" stroke-dashoffset="${213.6*(1-sprintT/30)}" style="transition:stroke-dashoffset .9s linear;transform:rotate(-90deg);transform-origin:40px 40px"/>
</svg>
<div id="timer-num" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Amiri',serif;font-size:1.4rem;color:${sprintT<=5?'var(--rose2)':'var(--rose)'}">${sprintT}</div>
</div>
<div class="sprint-q">${esc(q.q)}</div>
<div class="sprint-opts">${si.map((orig,i)=>`<button class="sprint-opt" onclick="answerSprint(this,${orig},${q.c})">${letters[i]}. ${esc(q.a[orig])}</button>`).join('')}</div>`;
}
function answerSprint(btn,orig,correct){
  if(!sprintActive)return;
  document.querySelectorAll('.sprint-opt').forEach(b=>b.disabled=true);
  if(orig===correct){btn.classList.add('correct');sprintScore++;spawnParticle(btn.getBoundingClientRect().left+50,btn.getBoundingClientRect().top)}
  else btn.classList.add('wrong');
  sprintTotal++;sprintQIdx++;
  setTimeout(()=>{if(sprintActive)renderSprintQ()},500);
}
function endSprint(){
  if(sprintScore>stats.sprintBest)stats.sprintBest=sprintScore;
  addNour(sprintScore*10);saveStats();checkBadges();updateStatsUI();
  $('sprint-wrap').innerHTML=`<div class="start-screen">
<div class="start-icon"><svg class="icon" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--rose2)" stroke-width="1.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
<div class="start-title">Sprint terminé !</div>
<div class="start-desc">Score : <strong style="color:var(--text);font-size:1.1rem">${sprintScore}</strong> / ${sprintTotal}<br>+${sprintScore*10} Nour<br><span style="color:var(--gold)">Record : ${stats.sprintBest}</span></div>
<button class="btn-ghost" style="max-width:200px;margin:0 auto;border-color:var(--rose);color:var(--rose2)" onclick="startSprint()">Rejouer</button></div>`;
}

/* ════════════════════ MEMORY DHIKR ════════════════════ */
function startMemory(){
  memMatched=0;memMoves=0;memFlipped=[];memLocked=false;
  const pool=shuffle(DHIKR_MEMORY).slice(0,6);
  memTotal=pool.length;
  const cards=[];
  pool.forEach((d,i)=>{
    cards.push({id:'a'+i,pairId:i,type:'ar',ar:d.ar,fr:d.fr,ph:d.ph,matched:false,flipped:false});
    cards.push({id:'b'+i,pairId:i,type:'fr',ar:d.ar,fr:d.fr,ph:d.ph,matched:false,flipped:false});
  });
  memCards=shuffle(cards);
  renderMemory();
}
function renderMemory(){
  const mw=$('memory-wrap');
  let h=`<div style="font-family:'Amiri',serif;font-size:1.15rem;color:var(--gold2);text-align:center;margin-bottom:4px">Memory Dhikr</div>
<div style="font-size:.7rem;color:var(--muted2);text-align:center;margin-bottom:12px">Associe le dhikr arabe ↔ sa traduction</div>
<div class="mem-stats">
<div class="mem-stat"><div class="mem-stat-val" id="mem-pairs">${memMatched}/${memTotal}</div><div class="mem-stat-lbl">Paires</div></div>
<div class="mem-stat"><div class="mem-stat-val" id="mem-moves">${memMoves}</div><div class="mem-stat-lbl">Coups</div></div>
</div><div class="memory-grid" id="mem-grid">`;
  memCards.forEach((c,i)=>{
    const isAr=c.type==='ar';
    h+=`<div class="mem-card${c.flipped?' flipped':''}${c.matched?' matched':''}" id="mc-${c.id}" data-type="${c.type}" onclick="flipMem(${i})">
<div class="mem-face-back">
<svg class="icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.2)" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
<div style="font-size:.48rem;color:var(--muted);margin-top:3px;text-transform:uppercase;letter-spacing:1px">${isAr?'arabe':'traduction'}</div>
</div>
<div class="mem-face-front">
${isAr?`<div class="mem-ar">${c.ar}</div><div class="mem-type">Dhikr</div>`:`<div class="mem-fr">${c.fr}</div><div style="font-size:.5rem;color:var(--gold);font-style:italic;margin-top:3px">${c.ph}</div><div class="mem-type">Traduction</div>`}
</div></div>`;
  });
  h+=`</div>`;
  mw.innerHTML=h;
}
function flipMem(i){
  if(memLocked)return;
  const c=memCards[i];if(c.flipped||c.matched)return;
  c.flipped=true;
  const el=$('mc-'+c.id);if(el)el.classList.add('flipped');
  memFlipped.push(i);
  if(memFlipped.length===2){
    memMoves++;memLocked=true;
    const [a,b]=memFlipped;
    if(memCards[a].pairId===memCards[b].pairId&&memCards[a].type!==memCards[b].type){
      // Match!
      memCards[a].matched=true;memCards[b].matched=true;
      const ea=$('mc-'+memCards[a].id),eb=$('mc-'+memCards[b].id);
      if(ea)ea.classList.add('matched');if(eb)eb.classList.add('matched');
      memMatched++;
      const pm=$('mem-pairs');if(pm)pm.textContent=memMatched+'/'+memTotal;
      const mm=$('mem-moves');if(mm)mm.textContent=memMoves;
      spawnParticle(window.innerWidth/2,window.innerHeight/3);
      addNour(15);
      // Show the dhikr phonetic as toast
      toast(memCards[a].ar+' — '+memCards[a].fr);
      memFlipped=[];memLocked=false;
      if(memMatched===memTotal){
        stats.memoryDone++;saveStats();updateStatsUI();checkBadges();
        setTimeout(()=>{
          $('memory-wrap').insertAdjacentHTML('beforeend',`
<div class="card" style="text-align:center;margin-top:10px;border-color:var(--gold)">
<div style="display:flex;justify-content:center;margin-bottom:8px"><svg class="icon" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="1.5"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></div>
<div style="font-family:'Amiri',serif;font-size:1.3rem;color:var(--gold2);margin:6px 0">Memory complété !</div>
<div style="font-size:.74rem;color:var(--muted2);margin-bottom:12px">${memMoves} coups · +${memTotal*15} Nour</div>
<button class="btn-teal" onclick="startMemory()">Rejouer</button></div>`);
        },400);
      }
    }else{
      // No match
      setTimeout(()=>{
        memCards[a].flipped=false;memCards[b].flipped=false;
        const ea=$('mc-'+memCards[a].id),eb=$('mc-'+memCards[b].id);
        if(ea)ea.classList.remove('flipped');if(eb)eb.classList.remove('flipped');
        memFlipped=[];memLocked=false;
        const mm=$('mem-moves');if(mm)mm.textContent=memMoves;
      },1000);
    }
  }
}

/* ════════════════════ WORD SEARCH ════════════════════ */
function startWS(){
  wsFound=[];wsSelected=[];
  wsWords=shuffle(WS_WORDS).slice(0,7);
  const size=10,grid=Array.from({length:size},()=>Array(size).fill(''));
  const dirs=[[0,1],[1,0],[0,-1],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]];
  wsWords.forEach(word=>{
    let placed=false,tries=0;
    while(!placed&&tries<300){tries++;
      const [dr,dc]=dirs[0|Math.random()*dirs.length];
      const r=0|Math.random()*size,c=0|Math.random()*size;let ok=true;
      for(let i=0;i<word.length;i++){const nr=r+dr*i,nc=c+dc*i;if(nr<0||nr>=size||nc<0||nc>=size||grid[nr][nc]&&grid[nr][nc]!==word[i]){ok=false;break}}
      if(ok){for(let i=0;i<word.length;i++)grid[r+dr*i][c+dc*i]=word[i];placed=true}
    }
  });
  const alpha='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  for(let r=0;r<size;r++)for(let c=0;c<size;c++)if(!grid[r][c])grid[r][c]=alpha[0|Math.random()*26];
  wsGrid=grid;renderWS();
}
function renderWS(){
  const size=10;
  let h=`<div class="panel-title" style="margin-bottom:8px">Mots mêlés</div>
<div class="ws-words" id="ws-words-list">`;
  wsWords.forEach(w=>{h+=`<div class="ws-word${wsFound.includes(w)?' found':''}" id="ww-${w}">${w}</div>`});
  h+=`</div><div class="ws-grid" id="ws-grid">`;
  for(let r=0;r<size;r++)for(let c=0;c<size;c++){
    const idx=r*size+c;
    h+=`<div class="ws-cell" id="wsc-${idx}" onmousedown="wsDown(${idx})" onmouseover="wsOver(${idx})" onmouseup="wsUp()" ontouchstart="event.preventDefault();wsDown(${idx})" ontouchmove="wsTM(event)" ontouchend="wsUp()">${wsGrid[r][c]}</div>`;
  }
  h+=`</div><div style="text-align:center;margin-top:8px"><button class="btn-sm" onclick="startWS()">Nouvelle grille</button></div>`;
  $('ws-wrap').innerHTML=h;
}
function wsDown(idx){wsDragging=true;wsStartCell=idx;wsSelected=[idx];refreshWSCells()}
function wsOver(idx){
  if(!wsDragging||wsStartCell===null)return;
  const size=10,sr=0|wsStartCell/size,sc=wsStartCell%size,er=0|idx/size,ec=idx%size;
  const dr=er-sr,dc=ec-sc,len=Math.max(Math.abs(dr),Math.abs(dc));
  if(len===0){wsSelected=[wsStartCell];refreshWSCells();return}
  if(Math.abs(dr)!==Math.abs(dc)&&dr!==0&&dc!==0)return;
  const stepR=dr===0?0:dr/Math.abs(dr),stepC=dc===0?0:dc/Math.abs(dc);
  wsSelected=[];for(let i=0;i<=len;i++)wsSelected.push((sr+stepR*i)*size+(sc+stepC*i));
  refreshWSCells();
}
function wsTM(e){const el=document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY);if(el?.id?.startsWith('wsc-'))wsOver(parseInt(el.id.replace('wsc-','')))}
function wsUp(){wsDragging=false;checkWSWord()}
function refreshWSCells(){document.querySelectorAll('.ws-cell').forEach((el,i)=>el.classList.toggle('selected',wsSelected.includes(i)))}
function checkWSWord(){
  const size=10,letters=wsSelected.map(i=>wsGrid[0|i/size][i%size]).join('');
  const rev=letters.split('').reverse().join('');
  const match=wsWords.find(w=>w===letters||w===rev);
  if(match&&!wsFound.includes(match)){
    wsFound.push(match);
    const ww=$('ww-'+match);if(ww)ww.classList.add('found');
    wsSelected.forEach(i=>{const el=$('wsc-'+i);if(el)el.classList.add('found-cell')});
    stats.wordsFound++;saveStats();addNour(35);updateStatsUI();checkBadges();
    for(let i=0;i<6;i++)setTimeout(()=>spawnParticle(window.innerWidth/2+Math.random()*80-40,window.innerHeight/2),i*70);
    toast(match+' trouvé ! +35 Nour');
    if(wsFound.length===wsWords.length){
      setTimeout(()=>{
        $('ws-wrap').insertAdjacentHTML('beforeend',`
<div class="card" style="text-align:center;margin-top:10px;border-color:rgba(167,139,250,.4)">
<div style="display:flex;justify-content:center;margin-bottom:8px"><svg class="icon" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--purple2)" stroke-width="1.5"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></div>
<div style="font-family:'Amiri',serif;font-size:1.2rem;color:var(--purple2);margin:6px 0">Tous les mots trouvés !</div>
<div style="font-size:.74rem;color:var(--muted2);margin-bottom:12px">+${wsWords.length*35} Nour</div>
<button class="btn-ghost" style="border-color:var(--purple);color:var(--purple2)" onclick="startWS()">Nouvelle grille</button></div>`);
      },400);
    }
  }
  wsSelected=[];refreshWSCells();
}

/* ════════════════════ HADITHS ════════════════════ */
function renderHadiths(){
  const liked=JSON.parse(localStorage.getItem('sk_liked_'+spaceCode)||'[]');
  const seen=JSON.parse(localStorage.getItem('sk_seen_'+spaceCode)||'[]');
  const list=$('hadith-list');if(!list)return;list.innerHTML='';
  HADITHS.forEach((h,i)=>{
    const isLiked=liked.includes(i);
    const d=document.createElement('div');d.className='h-card';d.id='hc'+i;
    d.innerHTML=`<div class="h-num">Hadith ${h.num} · <span class="tag ${h.cat==='Ramadan'||h.cat==='Coran'?'gold':'teal'}">${h.cat}</span></div>
<div class="h-ar">${h.ar}</div><div class="h-fr">"${h.fr}"</div><div class="h-src">— ${h.src}</div>
<div class="h-reveal"><p class="h-vertu">${h.vertu}</p></div>
<div class="h-actions" onclick="event.stopPropagation()">
<button class="action-btn${isLiked?' liked':''}" onclick="toggleLike(${i})">
<svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="${isLiked?'currentColor':'none'}" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>${isLiked?'Aimé':'Aimer'}</button>
<button class="action-btn" onclick="shareHadith(${i})">
<svg class="icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>Partager</button>
</div>`;
    d.addEventListener('click',()=>{
      d.classList.toggle('open');
      if(!seen.includes(i)){seen.push(i);localStorage.setItem('sk_seen_'+spaceCode,JSON.stringify(seen));stats.hadithRead=seen.length;addNour(5);saveStats();updateStatsUI();checkBadges()}
    });
    list.appendChild(d);
  });
}
function toggleLike(i){
  const liked=JSON.parse(localStorage.getItem('sk_liked_'+spaceCode)||'[]');
  const idx=liked.indexOf(i);if(idx>=0)liked.splice(idx,1);else liked.push(i);
  localStorage.setItem('sk_liked_'+spaceCode,JSON.stringify(liked));renderHadiths();
}
function shareHadith(i){
  const h=HADITHS[i];
  const msg={from:myName,text:'"'+h.fr+'" — '+h.src,time:tnow(),ts:Date.now()};
  if(db)db.ref(`spaces/${spaceCode}/chat`).push(msg);else appendChatMsg(msg,'local_'+Date.now());
  showPanel('chat');toast('Hadith partagé au chat');
}

/* ════════════════════ DUAS ════════════════════ */
let activeDuaCat='Tous';
function renderDuas(){
  const cats=['Tous',...new Set(DUAS.map(d=>d.cat))];
  const ce=$('dua-cats');if(!ce)return;ce.innerHTML='';
  cats.forEach(c=>{const b=document.createElement('div');b.className='dua-cat'+(c===activeDuaCat?' active':'');b.textContent=c;b.onclick=()=>{activeDuaCat=c;renderDuas()};ce.appendChild(b)});
  const dl=$('dua-list');if(!dl)return;dl.innerHTML='';
  DUAS.filter(d=>activeDuaCat==='Tous'||d.cat===activeDuaCat).forEach(d=>{
    const el=document.createElement('div');el.className='dua-card';
    el.innerHTML=`<div class="dua-sit">${d.sit}</div><div class="dua-ar">${d.ar}</div><div class="dua-ph">${d.ph}</div><div class="dua-fr">${d.fr}</div><div class="dua-src">— ${d.src}</div>`;
    dl.appendChild(el);
  });
}

/* ════════════════════ DHIKR ════════════════════ */
function renderDhikrSelect(){
  const el=$('dhikr-select');if(!el)return;el.innerHTML='';
  DHIKR_LIST.forEach((d,i)=>{
    const b=document.createElement('div');b.className='dhikr-opt'+(i===dhikrIdx?' active':'');
    b.innerHTML=`<span class="do-ar">${d.ar}</span><span class="do-fr">${d.fr}</span>`;
    b.onclick=()=>{dhikrIdx=i;dhikrCount=0;renderDhikrSelect();updateDhikrUI()};
    el.appendChild(b);
  });updateDhikrUI();
}
function updateDhikrUI(){
  const d=DHIKR_LIST[dhikrIdx];
  const set=(id,v)=>{const e=$(id);if(e)e.textContent=v};
  set('dhikr-ar',d.ar);set('dhikr-fr-txt',d.fr);set('dhikr-count',dhikrCount);set('dhikr-target',dhikrCount+' / '+d.target);
  const ring=$('dhikr-ring');if(ring)ring.style.strokeDashoffset=301.6*(1-Math.min(dhikrCount/d.target,1));
}
function tapDhikr(){
  const d=DHIKR_LIST[dhikrIdx];
  if(dhikrCount>=d.target){toast(d.fr+' complété !');return}
  dhikrCount++;stats.dhikrTotal++;updateDhikrUI();
  spawnParticle(window.innerWidth/2+Math.random()*40-20,window.innerHeight/2);
  if(dhikrCount===d.target){toast('Mashallah ! '+d.target+'× accompli !');addNour(20)}
  if(stats.dhikrTotal%50===0)addNour(10);
  saveStats();updateStatsUI();checkBadges();
}
function undoDhikr(){if(dhikrCount>0){dhikrCount--;if(stats.dhikrTotal>0)stats.dhikrTotal--;updateDhikrUI()}}
function resetDhikr(){dhikrCount=0;updateDhikrUI()}

/* ════════════════════ LEADERBOARD ════════════════════ */
function renderLeaderboard(){
  const lb=$('lb-list');if(!lb)return;
  lb.innerHTML=`<div style="color:var(--muted);font-size:.8rem;text-align:center;padding:10px">Chargement…</div>`;
  let players=[{name:myName,nour:stats.nour,isMe:true}];
  if(db){
    db.ref(`spaces/${spaceCode}/scores`).once('value',snap=>{
      const sc=snap.val()||{};
      players=Object.values(sc).map(s=>({name:s.name,nour:s.nour||0,isMe:s.name===myName}));
      if(!players.find(p=>p.isMe))players.push({name:myName,nour:stats.nour,isMe:true});
      renderLBList(players);
    });
  }else renderLBList(players);
  const bg=$('badges-grid');if(!bg)return;bg.innerHTML='';
  BADGES.forEach(b=>{
    const u=earnedBadges.has(b.id);const d=document.createElement('div');d.className='badge-card '+(u?'unlocked':'locked');
    d.innerHTML=`<div class="bc-icon">${BADGE_SVGS[b.svgKey]||''}</div><div class="bc-name">${b.name}</div><div class="bc-req">${b.req}</div>`;
    bg.appendChild(d);
  });
}
function renderLBList(players){
  const lb=$('lb-list');if(!lb)return;
  players.sort((a,b)=>b.nour-a.nour);lb.innerHTML='';
  const ri=['<svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#FFD700" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>',
  '<svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#C0C0C0" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>',
  '<svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#CD7F32" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>'];
  players.forEach((p,i)=>{
    const lv=getLevel(p.nour);const d=document.createElement('div');d.className='lb-card'+(p.isMe?' me':'');
    d.innerHTML=`<div class="lb-rank">${ri[i]||`<span style="font-size:.8rem;color:var(--muted)">#${i+1}</span>`}</div>
<div class="lb-av" style="background:rgba(${p.isMe?'212,168,67':'19,181,164'},.15);border:2px solid ${p.isMe?'var(--gold)':'var(--teal2)'};color:${p.isMe?'var(--gold)':'var(--teal2)'}">${(p.name||'?').charAt(0).toUpperCase()}</div>
<div class="lb-info"><div class="lb-name">${esc(p.name||'?')}${p.isMe?' <span style="font-size:.58rem;color:var(--muted)">(moi)</span>':''}</div><div class="lb-pts">${lv.name}</div></div>
<div style="text-align:right"><div class="lb-nour">${p.nour}</div><div class="lb-nour-lbl">Nour</div></div>`;
    lb.appendChild(d);
  });
}

/* ════════════════════ BOOT ════════════════════ */
window.onload=()=>{
  const name=localStorage.getItem('sk_name');const code=localStorage.getItem('sk_code');
  if(name)$('ln').value=name;if(code)$('lcode').value=code;
};
</script>

</body>
</html>
